<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin Panel | Safe Network</title>
<link rel="icon" href="https://res.cloudinary.com/dqn1tnmhl/image/upload/v1771979447/SN_ico_remukb.png"/>
<meta name="robots" content="noindex,nofollow"/>
<link rel="stylesheet" href="/css/global.css">
<link rel="stylesheet" href="/css/auth.css">
<link rel="stylesheet" href="/css/profile.css">
<link rel="stylesheet" href="/css/cookies.css">
<script src="/js/sanitize.js"></script>
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<!-- Customer.io CDP -->
<script>
  !function(){var i="cioanalytics",analytics=(window[i]=window[i]||[]);if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var key=analytics.methods[e];analytics[key]=analytics.factory(key)}analytics.load=function(key,e){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.setAttribute("data-global-customerio-analytics-key",i);t.src="https://cdp.customer.io/v1/analytics-js/snippet/"+key+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);analytics._writeKey=key;analytics._loadOptions=e};analytics.SNIPPET_VERSION="4.15.3";analytics.load("fff0a491b3c7bc207df6");analytics.page()}}();
</script>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">
    <img src="https://images.whatnot.com/fit-in/3840x0/filters:format(webp)/users%2F52444196%2Fb252b0ef-b6ce-4c9f-ba86-18ffd423776f.png" alt="Safe Network"/>
    <span>SAFE NETWORK</span>
  </a>
  <ul class="nav-links">
    <li><a href="/#shows">Shows</a></li>
    <li><a href="/#host">Hosts</a></li>
    <li><a href="https://www.whatnot.com/user/safenetwork" target="_blank">Watch Live</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/schedule.html">Schedule</a></li>
    <li class="nav-secondary"><a href="/#socials">Links</a></li>
  </ul>
  <button id="authLoginBtn" class="auth-login-btn" onclick="window.snAuth && snAuth.login()">Log In</button>
  <div id="authProfileWrap" class="auth-profile-wrap">
    <div class="auth-avatar" onclick="snAuth.toggleProfileDropdown()">
      <img id="authAvatarImg" alt="Profile"/>
      <span id="authAvatarInitials" class="auth-avatar-initials"></span>
    </div>
    <div id="authDropdown" class="auth-dropdown">
      <div class="auth-dropdown-label">Signed in as</div>
      <div id="authDropdownEmail" class="auth-dropdown-email"></div>
      <button class="auth-logout-btn" onclick="snAuth.logout()">Log Out</button>
    </div>
  </div>
  <button class="hamburger" onclick="toggleMenu()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
</nav>

<ul class="mobile-menu" id="mobileMenu">
  <li><a href="/#shows">Shows</a></li>
  <li><a href="/#host">Hosts</a></li>
  <li><a href="https://www.whatnot.com/user/safenetwork" target="_blank">Watch Live</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/schedule.html">Schedule</a></li>
  <li><a href="/#socials">Links</a></li>
  <li id="authMobileLogin" class="auth-mobile-login"><a href="#" onclick="event.preventDefault();window.snAuth && snAuth.login()">Log In</a></li>
  <li id="authMobileProfile" class="auth-mobile-profile">
    <div class="auth-mobile-signed-in">Signed in as <span id="authMobileEmail" class="auth-mobile-email"></span></div>
    <button class="auth-mobile-logout" onclick="snAuth.logout()">Log Out</button>
  </li>
</ul>

<!-- Loading State -->
<div class="admin-wrap" id="adminLoading">
  <div class="profile-loading">
    <p>Checking access...</p>
  </div>
</div>

<!-- Access Denied -->
<div class="admin-wrap" id="adminDenied" style="display:none">
  <div class="admin-denied">
    <h1>Access Denied</h1>
    <p>You don't have permission to view this page. This area is restricted to Safe Network administrators.</p>
    <a href="/" class="btn-primary" style="display:inline-block;text-decoration:none;padding:14px 36px;border-radius:10px">Back to Home</a>
  </div>
</div>

<!-- Admin Content -->
<div class="admin-wrap" id="adminContent" style="display:none">
  <h1>Admin Panel</h1>
  <p style="color:var(--silver);font-size:14px;margin-bottom:24px">Manage users, roles, loyalty, and wishlists for the Safe Network.</p>

  <!-- Tab Navigation -->
  <div class="admin-tabs">
    <button class="admin-tab active" id="tabUsers" onclick="switchAdminTab('users')">Users</button>
    <button class="admin-tab" id="tabWishes" onclick="switchAdminTab('wishes')">Wishes</button>
    <button class="admin-tab" id="tabSchedule" onclick="switchAdminTab('schedule')">Schedule</button>
    <button class="admin-tab" id="tabCollections" onclick="switchAdminTab('collections')">Collections</button>
    <button class="admin-tab" id="tabFeed" onclick="switchAdminTab('feed')">Feed</button>
  </div>

  <!-- â•â•â• Users Tab â•â•â• -->
  <div id="adminTabUsers">

  <!-- Stats Summary -->
  <div class="admin-stats" id="adminStats">
    <div class="stat-card blue">
      <div class="stat-number" id="statTotal">-</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card green">
      <div class="stat-number" id="statShoppers">-</div>
      <div class="stat-label">Shoppers</div>
    </div>
    <div class="stat-card gold">
      <div class="stat-number" id="statHosts">-</div>
      <div class="stat-label">Hosts</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-number" id="statAdmins">-</div>
      <div class="stat-label">Admins</div>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="admin-search">
    <input type="text" id="adminSearchInput" placeholder="Search by username, email, or name..." oninput="debounceSearch()"/>
    <select class="admin-filter" id="adminRoleFilter" onchange="loadUsers()">
      <option value="">All Roles</option>
      <option value="shopper">Shoppers</option>
      <option value="host">Hosts</option>
      <option value="admin">Admins</option>
    </select>
  </div>

  <!-- Users Table -->
  <div class="admin-table-wrap">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Tier</th>
          <th>Points</th>
          <th>Joined</th>
        </tr>
      </thead>
      <tbody id="adminTableBody">
        <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">Loading users...</td></tr>
      </tbody>
    </table>
  </div>

  </div><!-- /adminTabUsers -->

  <!-- â•â•â• Wishes Tab â•â•â• -->
  <div id="adminTabWishes" style="display:none">

    <!-- Wish Stats -->
    <div class="admin-stats">
      <div class="stat-card blue">
        <div class="stat-number" id="wishStatTotal">-</div>
        <div class="stat-label">Total Wishes</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-number" id="wishStatCoins">-</div>
        <div class="stat-label">Coins</div>
      </div>
      <div class="stat-card" style="background:rgba(255,107,107,.06);border-color:rgba(255,107,107,.15)">
        <div class="stat-number" id="wishStatPokemon" style="color:#ff6b6b">-</div>
        <div class="stat-label">Pokemon</div>
      </div>
      <div class="stat-card green">
        <div class="stat-number" id="wishStatSports">-</div>
        <div class="stat-label">Sports Cards</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="admin-search">
      <input type="text" id="wishSearchInput" placeholder="Search wishes by description..." oninput="debounceWishSearch()"/>
      <select class="admin-filter" id="wishCategoryFilter" onchange="loadWishes()">
        <option value="">All Categories</option>
        <option value="coins">Coins &amp; Bullion</option>
        <option value="pokemon">Pokemon</option>
        <option value="sports_cards">Sports Cards</option>
        <option value="shoes">Shoes</option>
      </select>
    </div>

    <!-- Wishes Table -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Category</th>
            <th>Details</th>
            <th>User</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="wishTableBody">
          <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--silver)">Loading wishes...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabWishes -->

  <!-- â•â•â• Schedule Tab â•â•â• -->
  <div id="adminTabSchedule" style="display:none">

    <!-- Create Show Form -->
    <div style="background:rgba(255,255,255,.03);border:1px solid rgba(30,144,255,.15);border-radius:16px;padding:24px;margin-bottom:28px">
      <h3 style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;margin-bottom:16px">Schedule a Show</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="admin-edit-field" style="margin:0">
          <label>Host</label>
          <select id="schedHostSlug"></select>
        </div>
        <div class="admin-edit-field" style="margin:0">
          <label>Show Type</label>
          <select id="schedShowType">
            <option value="coins">ğŸª™ Coins &amp; Bullion</option>
            <option value="pokemon">âš¡ Pokemon</option>
            <option value="sports">ğŸ€ Sports Cards</option>
            <option value="shoes">ğŸ‘Ÿ Shoes</option>
          </select>
        </div>
      </div>
      <div class="admin-edit-field" style="margin:0 0 12px">
        <label>Title</label>
        <input type="text" id="schedTitle" placeholder="e.g. Coins &amp; Bullion Live Auction" style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="admin-edit-field" style="margin:0">
          <label>Date &amp; Time</label>
          <input type="datetime-local" id="schedDateTime" style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none;color-scheme:dark"/>
        </div>
        <div class="admin-edit-field" style="margin:0">
          <label>Duration (min)</label>
          <input type="number" id="schedDuration" value="60" min="15" max="480" style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
        </div>
        <div class="admin-edit-field" style="margin:0">
          <label>Whatnot URL (optional)</label>
          <input type="url" id="schedWhatnotUrl" placeholder="https://www.whatnot.com/..." style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
        </div>
      </div>
      <div class="admin-edit-field" style="margin:0 0 16px">
        <label>Description (optional)</label>
        <input type="text" id="schedDesc" placeholder="Brief description of this show..." style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
      </div>
      <button class="admin-save-btn" id="schedCreateBtn" onclick="createShow()" style="margin:0">Create Show</button>
      <span id="schedCreateStatus" style="margin-left:12px;font-size:13px"></span>
    </div>

    <!-- Scheduled Shows List -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Title</th>
            <th>Host</th>
            <th>Type</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="schedTableBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">Loading shows...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabSchedule -->

  <!-- â•â•â• Collections Tab â•â•â• -->
  <div id="adminTabCollections" style="display:none">

    <!-- Collection Stats -->
    <div class="admin-stats">
      <div class="stat-card blue">
        <div class="stat-number" id="collStatTotal">-</div>
        <div class="stat-label">Total Items</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-number" id="collStatCoins">-</div>
        <div class="stat-label">Coins</div>
      </div>
      <div class="stat-card" style="background:rgba(255,107,107,.06);border-color:rgba(255,107,107,.15)">
        <div class="stat-number" id="collStatPokemon" style="color:#ff6b6b">-</div>
        <div class="stat-label">Pokemon</div>
      </div>
      <div class="stat-card green">
        <div class="stat-number" id="collStatSports">-</div>
        <div class="stat-label">Sports Cards</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="admin-search">
      <input type="text" id="collSearchInput" placeholder="Search collection items by description..." oninput="debounceCollSearch()"/>
      <select class="admin-filter" id="collCategoryFilter" onchange="loadAdminCollections()">
        <option value="">All Categories</option>
        <option value="coins">Coins &amp; Bullion</option>
        <option value="pokemon">Pokemon</option>
        <option value="sports_cards">Sports Cards</option>
        <option value="shoes">Shoes</option>
      </select>
    </div>

    <!-- Collections Table -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Photos</th>
            <th>Description</th>
            <th>Category</th>
            <th>Details</th>
            <th>User</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="collTableBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">Loading collections...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabCollections -->

  <!-- â•â•â• Feed Tab â•â•â• -->
  <div id="adminTabFeed" style="display:none">

    <!-- Feed Stats -->
    <div class="admin-stats">
      <div class="stat-card blue">
        <div class="stat-number" id="feedStatTotal">-</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-card green">
        <div class="stat-number" id="feedStatWishlist">-</div>
        <div class="stat-label">Wishlists</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-number" id="feedStatCollection">-</div>
        <div class="stat-label">Collections</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-number" id="feedStatInventory">-</div>
        <div class="stat-label">Inventory</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="admin-search">
      <select class="admin-filter" id="feedTypeFilter" onchange="loadAdminFeed()">
        <option value="">All Types</option>
        <option value="wishlist">Wishlists</option>
        <option value="collection">Collections</option>
        <option value="inventory">Inventory</option>
      </select>
      <select class="admin-filter" id="feedCatFilter" onchange="loadAdminFeed()">
        <option value="">All Categories</option>
        <option value="coins">Coins &amp; Bullion</option>
        <option value="pokemon">Pokemon</option>
        <option value="sports_cards">Sports Cards</option>
        <option value="shoes">Shoes</option>
      </select>
    </div>

    <!-- Feed Table -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Author</th>
            <th>Category</th>
            <th>Description</th>
            <th style="text-align:center">Reactions</th>
            <th style="text-align:center">Comments</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="feedTableBody">
          <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--silver)">Loading feed events...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabFeed -->

</div>

<!-- Edit User Panel (slide from right) -->
<div class="admin-edit-overlay" id="adminEditOverlay" onclick="closeEditPanel(event)">
  <div class="admin-edit-panel" onclick="event.stopPropagation()">
    <button class="admin-edit-close" onclick="closeEditPanel()">&times;</button>
    <h2>Edit User</h2>

    <div style="margin-bottom:20px;padding:16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px">
      <div style="color:var(--silver);font-size:12px;margin-bottom:4px">Username</div>
      <div id="editUsername" style="color:var(--blue);font-weight:600;font-size:16px">-</div>
      <div style="color:var(--silver);font-size:12px;margin-top:8px">Email</div>
      <div id="editEmail" style="color:var(--silver);font-size:14px">-</div>
    </div>

    <div class="admin-edit-field">
      <label>Role</label>
      <select id="editRole" onchange="onRoleChange()">
        <option value="shopper">Shopper</option>
        <option value="host">Host</option>
        <option value="admin">Admin</option>
      </select>
    </div>

    <div class="admin-edit-field" id="hostPickerField" style="display:none">
      <label>Linked Host</label>
      <select id="editHostSlug">
        <option value="">-- None --</option>
      </select>
    </div>

    <div class="admin-edit-field">
      <label>Loyalty Tier</label>
      <select id="editTier">
        <option value="bronze">Bronze</option>
        <option value="silver">Silver</option>
        <option value="gold">Gold</option>
        <option value="diamond">Diamond</option>
      </select>
    </div>

    <div class="admin-edit-field">
      <label>Loyalty Points</label>
      <input type="number" id="editPoints" min="0" step="1"/>
    </div>

    <button class="admin-save-btn" id="adminSaveBtn" onclick="saveUserEdits()">Save Changes</button>
    <div class="admin-edit-status" id="adminEditStatus"></div>
  </div>
</div>

<footer>
  <div class="footer-logo">SAFE NETWORK</div>
  <div><a href="/privacy.html">Privacy Policy</a> Â· <a href="/terms.html">Terms of Service</a></div>
  <p>2026 Safe Network Â· safenetwork.shop</p>
</footer>

<script>
  function toggleMenu(){
    document.getElementById('mobileMenu').classList.toggle('open');
    document.querySelector('.hamburger').classList.toggle('open');
  }
</script>
<script src="/js/supabase.js"></script>
<script src="/js/cookies.js"></script>
<script src="/js/auth.js"></script>
<script>
/* â”€â”€ Admin Page Logic â”€â”€ */
(function(){
  var allUsers = [];
  var editingUser = null;
  var searchTimer = null;
  var hostsList = [];

  /* â”€â”€ Initialize Admin Page â”€â”€ */
  async function initAdminPage(){
    var maxWait = 50;
    while(!window.snAuth && maxWait > 0){
      await new Promise(function(r){ setTimeout(r, 100); });
      maxWait--;
    }

    if(!window.snAuth){
      showSection('adminDenied');
      return;
    }

    var loggedIn = await snAuth.isLoggedIn();
    if(!loggedIn){
      showSection('adminDenied');
      return;
    }

    // Check if user is admin
    var profile = window.snProfile ? snProfile.getCachedProfile() : null;
    if(!profile){
      try {
        var user = await snAuth.getUser();
        var token = await snAuth.getAccessToken();
        if(user && token && window.snProfile){
          profile = await snProfile.initProfile(user, token);
        }
      } catch(err){
        console.warn('Admin profile check error:', err);
      }
    }

    if(!profile || profile.role !== 'admin'){
      showSection('adminDenied');
      return;
    }

    // User is admin - show panel, load hosts list, and load users
    showSection('adminContent');
    loadHostsList();
    loadUsers();
  }

  function showSection(id){
    document.getElementById('adminLoading').style.display = 'none';
    document.getElementById('adminDenied').style.display = 'none';
    document.getElementById('adminContent').style.display = 'none';
    document.getElementById(id).style.display = '';
  }

  /* â”€â”€ Load Hosts List â”€â”€ */
  async function loadHostsList(){
    try {
      hostsList = await snProfile.listHosts();
      var select = document.getElementById('editHostSlug');
      // Clear existing options beyond the default
      select.innerHTML = '<option value="">-- None --</option>';
      hostsList.forEach(function(h){
        var opt = document.createElement('option');
        opt.value = h.slug;
        opt.textContent = h.name;
        select.appendChild(opt);
      });
    } catch(err){
      console.warn('Load hosts error:', err);
    }
  }

  /* â”€â”€ Role Change Handler â”€â”€ */
  window.onRoleChange = function(){
    var role = document.getElementById('editRole').value;
    document.getElementById('hostPickerField').style.display = role === 'host' ? '' : 'none';
  };

  /* â”€â”€ Load Users â”€â”€ */
  window.loadUsers = async function(){
    var search = document.getElementById('adminSearchInput').value.trim();
    var roleFilter = document.getElementById('adminRoleFilter').value;

    try {
      var token = await snAuth.getAccessToken();
      allUsers = await snProfile.adminListUsers(token, search, roleFilter);
      renderUsers();
      updateStats();
    } catch(err){
      console.warn('Load users error:', err);
      var tbody = document.getElementById('adminTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#ff6b6b">Error loading users. Please try again.</td></tr>';
    }
  };

  /* â”€â”€ Render Users Table â”€â”€ */
  function renderUsers(){
    var tbody = document.getElementById('adminTableBody');
    if(!allUsers.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">No users found.</td></tr>';
      return;
    }

    var html = '';
    allUsers.forEach(function(u, idx){
      var joined = u.created_at ? new Date(u.created_at).toLocaleDateString() : '-';
      var safeRole = escapeHtml(u.role || 'shopper');
      var safeTier = escapeHtml(u.loyalty_tier || 'bronze');
      html += '<tr class="user-row" data-user-idx="' + idx + '">' +
        '<td class="username-cell">@' + escapeHtml(u.username || '') + '</td>' +
        '<td>' + escapeHtml(u.email || '') + '</td>' +
        '<td><span class="profile-badge badge-' + safeRole + '">' + safeRole + '</span></td>' +
        '<td><span class="profile-badge badge-' + safeTier + '">' + safeTier + '</span></td>' +
        '<td>' + (parseInt(u.loyalty_points, 10) || 0) + '</td>' +
        '<td>' + joined + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
    // Attach click handlers via event delegation (safe - no inline JS injection)
    tbody.querySelectorAll('.user-row').forEach(function(row){
      row.addEventListener('click', function(){
        var idx = parseInt(row.getAttribute('data-user-idx'), 10);
        if(allUsers[idx]) openEditPanel(JSON.stringify(allUsers[idx]));
      });
    });
  }

  /* â”€â”€ Update Stats â”€â”€ */
  function updateStats(){
    var total = allUsers.length;
    var shoppers = 0, hosts = 0, admins = 0;
    allUsers.forEach(function(u){
      if(u.role === 'host') hosts++;
      else if(u.role === 'admin') admins++;
      else shoppers++;
    });
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statShoppers').textContent = shoppers;
    document.getElementById('statHosts').textContent = hosts;
    document.getElementById('statAdmins').textContent = admins;
  }

  /* â”€â”€ Search Debounce â”€â”€ */
  window.debounceSearch = function(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(loadUsers, 400);
  };

  /* â”€â”€ Edit Panel â”€â”€ */
  window.openEditPanel = function(userJson){
    editingUser = JSON.parse(userJson);
    document.getElementById('editUsername').textContent = '@' + (editingUser.username || '');
    document.getElementById('editEmail').textContent = editingUser.email || '';
    document.getElementById('editRole').value = editingUser.role || 'shopper';
    document.getElementById('editHostSlug').value = editingUser.host_slug || '';
    document.getElementById('hostPickerField').style.display = (editingUser.role === 'host') ? '' : 'none';
    document.getElementById('editTier').value = editingUser.loyalty_tier || 'bronze';
    document.getElementById('editPoints').value = editingUser.loyalty_points || 0;
    document.getElementById('adminEditStatus').textContent = '';
    document.getElementById('adminEditOverlay').classList.add('open');
  };

  window.closeEditPanel = function(e){
    if(e && e.target !== document.getElementById('adminEditOverlay')) return;
    document.getElementById('adminEditOverlay').classList.remove('open');
    editingUser = null;
  };

  /* â”€â”€ Save User Edits â”€â”€ */
  window.saveUserEdits = async function(){
    if(!editingUser) return;

    var btn = document.getElementById('adminSaveBtn');
    var statusEl = document.getElementById('adminEditStatus');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    statusEl.textContent = '';

    var role = document.getElementById('editRole').value;
    var updates = {
      role: role,
      loyalty_tier: document.getElementById('editTier').value,
      loyalty_points: parseInt(document.getElementById('editPoints').value) || 0
    };

    if(role === 'host'){
      updates.host_slug = document.getElementById('editHostSlug').value || null;
    } else {
      updates.host_slug = null;
    }

    try {
      var token = await snAuth.getAccessToken();
      await snProfile.adminUpdateUser(editingUser.auth0_id, updates, token);
      statusEl.textContent = 'Saved!';
      statusEl.style.color = '#4ade80';

      // Refresh the user list
      setTimeout(function(){
        closeEditPanel();
        loadUsers();
      }, 800);
    } catch(err){
      console.warn('Admin save error:', err);
      statusEl.textContent = 'Error: ' + (err.message || 'Please try again.');
      statusEl.style.color = '#ff6b6b';
    }

    btn.disabled = false;
    btn.textContent = 'Save Changes';
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB SWITCHING + WISHES TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  var allWishes = [];
  var wishesLoaded = false;
  var wishSearchTimer = null;

  var WISH_CATEGORY_LABELS = {
    coins: 'Coins & Bullion',
    pokemon: 'Pokemon',
    sports_cards: 'Sports Cards',
    shoes: 'Shoes'
  };

  window.switchAdminTab = function(tab){
    document.getElementById('adminTabUsers').style.display = tab === 'users' ? '' : 'none';
    document.getElementById('adminTabWishes').style.display = tab === 'wishes' ? '' : 'none';
    document.getElementById('adminTabSchedule').style.display = tab === 'schedule' ? '' : 'none';
    document.getElementById('adminTabCollections').style.display = tab === 'collections' ? '' : 'none';
    document.getElementById('adminTabFeed').style.display = tab === 'feed' ? '' : 'none';
    document.getElementById('tabUsers').classList.toggle('active', tab === 'users');
    document.getElementById('tabWishes').classList.toggle('active', tab === 'wishes');
    document.getElementById('tabSchedule').classList.toggle('active', tab === 'schedule');
    document.getElementById('tabCollections').classList.toggle('active', tab === 'collections');
    document.getElementById('tabFeed').classList.toggle('active', tab === 'feed');
    if(tab === 'wishes' && !wishesLoaded) loadWishes();
    if(tab === 'schedule' && !scheduledShowsLoaded) loadScheduledShows();
    if(tab === 'collections' && !collectionsLoaded) loadAdminCollections();
    if(tab === 'feed' && !feedEventsLoaded) loadAdminFeed();
  };

  window.loadWishes = async function(){
    var search = document.getElementById('wishSearchInput').value.trim();
    var category = document.getElementById('wishCategoryFilter').value;
    try {
      var token = await snAuth.getAccessToken();
      allWishes = await snProfile.adminListWishes(token, category, search);
      wishesLoaded = true;
      renderWishes();
      updateWishStats();
    } catch(err){
      console.warn('Load wishes error:', err);
      document.getElementById('wishTableBody').innerHTML =
        '<tr><td colspan="5" style="text-align:center;padding:40px;color:#ff6b6b">Error loading wishes.</td></tr>';
    }
  };

  function renderWishes(){
    var tbody = document.getElementById('wishTableBody');
    if(!allWishes.length){
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--silver)">No wishes found.</td></tr>';
      return;
    }

    var html = '';
    allWishes.forEach(function(w){
      var date = w.created_at ? new Date(w.created_at).toLocaleDateString() : '-';
      var cat = w.category || '';
      var user = w.profiles ? ('@' + escapeHtml(w.profiles.username || '')) : '-';
      var details = w.details || {};
      var detailStr = Object.values(details).map(function(v){
        return escapeHtml(String(v).replace(/_/g, ' '));
      }).join(', ');

      html += '<tr>' +
        '<td style="max-width:300px">' + escapeHtml(w.description || '') + '</td>' +
        '<td><span class="profile-badge badge-' + escapeHtml(cat) + '" style="font-size:10px">' + escapeHtml(WISH_CATEGORY_LABELS[cat] || cat) + '</span></td>' +
        '<td style="font-size:12px;color:var(--silver)">' + (detailStr || '-') + '</td>' +
        '<td style="color:var(--blue);font-weight:600">' + user + '</td>' +
        '<td>' + date + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  function updateWishStats(){
    var total = allWishes.length;
    var coins = 0, pokemon = 0, sports = 0;
    allWishes.forEach(function(w){
      if(w.category === 'coins') coins++;
      else if(w.category === 'pokemon') pokemon++;
      else if(w.category === 'sports_cards') sports++;
    });
    document.getElementById('wishStatTotal').textContent = total;
    document.getElementById('wishStatCoins').textContent = coins;
    document.getElementById('wishStatPokemon').textContent = pokemon;
    document.getElementById('wishStatSports').textContent = sports;
  }

  window.debounceWishSearch = function(){
    clearTimeout(wishSearchTimer);
    wishSearchTimer = setTimeout(loadWishes, 400);
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCHEDULE TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  var scheduledShows = [];
  var scheduledShowsLoaded = false;

  var SHOW_TYPE_LABELS = {
    coins: 'ğŸª™ Coins & Bullion',
    pokemon: 'âš¡ Pokemon',
    sports: 'ğŸ€ Sports Cards',
    shoes: 'ğŸ‘Ÿ Shoes'
  };

  var STATUS_LABELS = {
    scheduled: 'Scheduled',
    live: 'ğŸ”´ Live',
    completed: 'Completed',
    cancelled: 'Cancelled'
  };

  /* â”€â”€ Load Scheduled Shows â”€â”€ */
  window.loadScheduledShows = async function(){
    try {
      // Populate host picker
      var hostSelect = document.getElementById('schedHostSlug');
      if(hostSelect.options.length <= 1){
        hostSelect.innerHTML = '';
        hostsList.forEach(function(h){
          var opt = document.createElement('option');
          opt.value = h.slug;
          opt.textContent = h.name;
          hostSelect.appendChild(opt);
        });
      }

      var result = await snProfile.listScheduledShows({ include_all: true });
      scheduledShows = result.shows || [];
      scheduledShowsLoaded = true;
      renderScheduledShows();
    } catch(err){
      console.warn('Load scheduled shows error:', err);
      document.getElementById('schedTableBody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;padding:40px;color:#ff6b6b">Error loading shows.</td></tr>';
    }
  };

  function renderScheduledShows(){
    var tbody = document.getElementById('schedTableBody');
    if(!scheduledShows.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">No shows scheduled. Create one above.</td></tr>';
      return;
    }

    // Sort by date descending (newest first)
    scheduledShows.sort(function(a,b){ return new Date(b.scheduled_at) - new Date(a.scheduled_at); });

    var html = '';
    scheduledShows.forEach(function(s){
      var d = new Date(s.scheduled_at);
      var dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      var timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      var typeLabel = SHOW_TYPE_LABELS[s.show_type] || s.show_type;
      var statusLabel = STATUS_LABELS[s.status] || s.status;
      var statusClass = 'badge-' + (s.status === 'live' ? 'live' : s.status === 'cancelled' ? 'soon' : 'shopper');

      var safeId = snSanitize.attr(s.id);
      var actions = '';
      if(s.status === 'scheduled'){
        actions += '<button onclick="updateShowStatus(\'' + safeId + '\',\'live\')" style="background:rgba(34,197,94,.12);color:#4ade80;border:1px solid rgba(34,197,94,.3);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;margin-right:4px">Go Live</button>';
        actions += '<button onclick="updateShowStatus(\'' + safeId + '\',\'cancelled\')" style="background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.2);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">Cancel</button>';
      } else if(s.status === 'live'){
        actions += '<button onclick="updateShowStatus(\'' + safeId + '\',\'completed\')" style="background:rgba(30,144,255,.12);color:var(--blue);border:1px solid rgba(30,144,255,.25);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">End Show</button>';
      } else {
        actions += '<button onclick="deleteShow(\'' + safeId + '\')" style="background:rgba(255,255,255,.04);color:var(--silver);border:1px solid rgba(255,255,255,.1);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">Delete</button>';
      }

      html += '<tr>' +
        '<td style="white-space:nowrap"><div style="font-weight:600">' + dateStr + '</div><div style="font-size:11px;color:var(--silver)">' + timeStr + '</div></td>' +
        '<td style="font-weight:600">' + escapeHtml(s.title || '') + '</td>' +
        '<td style="color:var(--blue);font-weight:600">@' + escapeHtml(s.host_handle || '') + '</td>' +
        '<td style="font-size:12px">' + typeLabel + '</td>' +
        '<td><span class="profile-badge ' + statusClass + '" style="font-size:10px">' + statusLabel + '</span></td>' +
        '<td>' + actions + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  /* â”€â”€ Create Show â”€â”€ */
  window.createShow = async function(){
    var btn = document.getElementById('schedCreateBtn');
    var statusEl = document.getElementById('schedCreateStatus');
    btn.disabled = true;
    btn.textContent = 'Creating...';
    statusEl.textContent = '';

    var dateVal = document.getElementById('schedDateTime').value;
    if(!dateVal){
      statusEl.textContent = 'Please select a date and time';
      statusEl.style.color = '#ff6b6b';
      btn.disabled = false;
      btn.textContent = 'Create Show';
      return;
    }

    var data = {
      host_slug: document.getElementById('schedHostSlug').value,
      show_type: document.getElementById('schedShowType').value,
      title: document.getElementById('schedTitle').value.trim() || (SHOW_TYPE_LABELS[document.getElementById('schedShowType').value] || 'Show'),
      description: document.getElementById('schedDesc').value.trim() || null,
      scheduled_at: new Date(dateVal).toISOString(),
      duration_minutes: parseInt(document.getElementById('schedDuration').value) || 60,
      whatnot_url: document.getElementById('schedWhatnotUrl').value.trim() || null
    };

    try {
      var token = await snAuth.getAccessToken();
      await snProfile.createScheduledShow(data, token);
      statusEl.textContent = 'Show created!';
      statusEl.style.color = '#4ade80';
      // Clear form
      document.getElementById('schedTitle').value = '';
      document.getElementById('schedDesc').value = '';
      document.getElementById('schedDateTime').value = '';
      document.getElementById('schedWhatnotUrl').value = '';
      // Reload list
      loadScheduledShows();
    } catch(err){
      statusEl.textContent = 'Error: ' + (err.message || 'Try again');
      statusEl.style.color = '#ff6b6b';
    }

    btn.disabled = false;
    btn.textContent = 'Create Show';
  };

  /* â”€â”€ Update Show Status â”€â”€ */
  window.updateShowStatus = async function(id, newStatus){
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.updateScheduledShow(id, { status: newStatus }, token);
      loadScheduledShows();
    } catch(err){
      alert('Error updating show: ' + (err.message || 'Try again'));
    }
  };

  /* â”€â”€ Delete Show â”€â”€ */
  window.deleteShow = async function(id){
    if(!confirm('Delete this show?')) return;
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.deleteScheduledShow(id, token);
      loadScheduledShows();
    } catch(err){
      alert('Error deleting show: ' + (err.message || 'Try again'));
    }
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COLLECTIONS TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  var allCollections = [];
  var collectionsLoaded = false;
  var collSearchTimer = null;

  var COLL_CATEGORY_LABELS = {
    coins: 'Coins & Bullion',
    pokemon: 'Pokemon',
    sports_cards: 'Sports Cards',
    shoes: 'Shoes'
  };

  window.loadAdminCollections = async function(){
    var search = document.getElementById('collSearchInput').value.trim();
    var category = document.getElementById('collCategoryFilter').value;
    try {
      var token = await snAuth.getAccessToken();
      allCollections = await snProfile.adminListCollections(token, category, search);
      collectionsLoaded = true;
      renderAdminCollections();
      updateCollStats();
    } catch(err){
      console.warn('Load collections error:', err);
      document.getElementById('collTableBody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;padding:40px;color:#ff6b6b">Error loading collections.</td></tr>';
    }
  };

  function renderAdminCollections(){
    var tbody = document.getElementById('collTableBody');
    if(!allCollections.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">No collection items found.</td></tr>';
      return;
    }

    var html = '';
    allCollections.forEach(function(c){
      var date = c.created_at ? new Date(c.created_at).toLocaleDateString() : '-';
      var cat = c.category || '';
      var user = c.profiles ? ('@' + escapeHtml(c.profiles.username || '')) : '-';
      var details = c.details || {};
      var detailStr = Object.values(details).map(function(v){
        return escapeHtml(String(v).replace(/_/g, ' '));
      }).join(', ');

      // Photo thumbnails
      var photos = c.photo_urls || [];
      var photoHtml = '';
      if(photos.length > 0){
        for(var p = 0; p < photos.length; p++){
          photoHtml += '<img src="' + escapeHtml(photos[p]) + '" style="width:36px;height:36px;border-radius:6px;object-fit:cover;margin-right:4px;border:1px solid rgba(255,255,255,.1)" loading="lazy"/>';
        }
      } else {
        photoHtml = '<span style="color:var(--silver);font-size:11px">No photos</span>';
      }

      html += '<tr>' +
        '<td>' + photoHtml + '</td>' +
        '<td style="max-width:250px">' + escapeHtml(c.description || '-') + '</td>' +
        '<td><span class="profile-badge badge-' + escapeHtml(cat) + '" style="font-size:10px">' + escapeHtml(COLL_CATEGORY_LABELS[cat] || cat) + '</span></td>' +
        '<td style="font-size:12px;color:var(--silver)">' + (detailStr || '-') + '</td>' +
        '<td style="color:var(--blue);font-weight:600">' + user + '</td>' +
        '<td>' + date + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  function updateCollStats(){
    var total = allCollections.length;
    var coins = 0, pokemon = 0, sports = 0;
    allCollections.forEach(function(c){
      if(c.category === 'coins') coins++;
      else if(c.category === 'pokemon') pokemon++;
      else if(c.category === 'sports_cards') sports++;
    });
    document.getElementById('collStatTotal').textContent = total;
    document.getElementById('collStatCoins').textContent = coins;
    document.getElementById('collStatPokemon').textContent = pokemon;
    document.getElementById('collStatSports').textContent = sports;
  }

  window.debounceCollSearch = function(){
    clearTimeout(collSearchTimer);
    collSearchTimer = setTimeout(loadAdminCollections, 400);
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FEED TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  var allFeedEvents = [];
  var feedEventsLoaded = false;

  var FEED_TYPE_LABELS = { wishlist: 'Wishlist', collection: 'Collection', inventory: 'Inventory' };
  var FEED_CAT_LABELS = { coins: 'Coins & Bullion', pokemon: 'Pokemon', sports_cards: 'Sports Cards', shoes: 'Shoes' };

  window.loadAdminFeed = async function(){
    var typeFilter = document.getElementById('feedTypeFilter').value;
    var catFilter = document.getElementById('feedCatFilter').value;
    try {
      var token = await snAuth.getAccessToken();
      // Use the public feed-get endpoint with optional filters
      // We fetch up to 200 events for admin view
      var cursor = null;
      var events = [];
      for(var page = 0; page < 10; page++){
        var headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
        var res = await fetch('https://qsoaransrvpabqpwnjdg.supabase.co/functions/v1/profile-sync', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({ action: 'feed-get', data: { cursor: cursor, category: catFilter || '', event_type: typeFilter || '' } })
        });
        var json = await res.json();
        var batch = json.events || [];
        events = events.concat(batch);
        cursor = json.next_cursor;
        if(!cursor || events.length >= 200) break;
      }
      allFeedEvents = events;
      feedEventsLoaded = true;
      renderAdminFeed();
      updateFeedStats();
    } catch(err){
      console.warn('Load feed error:', err);
      document.getElementById('feedTableBody').innerHTML =
        '<tr><td colspan="8" style="text-align:center;padding:40px;color:#ff6b6b">Error loading feed.</td></tr>';
    }
  };

  function renderAdminFeed(){
    var tbody = document.getElementById('feedTableBody');
    if(!allFeedEvents.length){
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--silver)">No feed events found.</td></tr>';
      return;
    }

    var html = '';
    allFeedEvents.forEach(function(ev){
      var date = ev.created_at ? new Date(ev.created_at).toLocaleDateString() : '-';
      var cat = ev.category || '';
      var typeLabel = FEED_TYPE_LABELS[ev.event_type] || ev.event_type;
      var catLabel = FEED_CAT_LABELS[cat] || cat;

      // Type badge color
      var typeColor = ev.event_type === 'wishlist' ? 'var(--blue)' : ev.event_type === 'collection' ? '#4ade80' : 'var(--gold2)';

      // Reaction total
      var counts = ev.reaction_counts || {};
      var totalReactions = 0;
      for(var k in counts) totalReactions += (counts[k] || 0);

      html += '<tr>' +
        '<td><span style="color:' + typeColor + ';font-weight:700;font-size:11px;text-transform:uppercase">' + escapeHtml(typeLabel) + '</span></td>' +
        '<td style="color:var(--blue);font-weight:600;font-size:12px">@' + escapeHtml(ev.author_username || '-') + '</td>' +
        '<td><span class="profile-badge badge-' + escapeHtml(cat) + '" style="font-size:10px">' + escapeHtml(catLabel) + '</span></td>' +
        '<td style="max-width:200px;font-size:12px">' + escapeHtml((ev.description || '').slice(0, 80)) + '</td>' +
        '<td style="text-align:center;font-size:12px">' + totalReactions + '</td>' +
        '<td style="text-align:center;font-size:12px">' + (ev.comment_count || 0) + '</td>' +
        '<td style="font-size:12px">' + date + '</td>' +
        '<td><button onclick="deleteAdminFeedEvent(\'' + escapeHtml(ev.id) + '\')" style="background:rgba(255,100,100,.1);border:1px solid rgba(255,100,100,.2);color:#ff6b6b;padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">Delete</button></td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  function updateFeedStats(){
    var total = allFeedEvents.length;
    var wishlist = 0, collection = 0, inventory = 0;
    allFeedEvents.forEach(function(ev){
      if(ev.event_type === 'wishlist') wishlist++;
      else if(ev.event_type === 'collection') collection++;
      else if(ev.event_type === 'inventory') inventory++;
    });
    document.getElementById('feedStatTotal').textContent = total;
    document.getElementById('feedStatWishlist').textContent = wishlist;
    document.getElementById('feedStatCollection').textContent = collection;
    document.getElementById('feedStatInventory').textContent = inventory;
  }

  window.deleteAdminFeedEvent = async function(eventId){
    if(!confirm('Delete this feed event? This will also delete its reactions and comments.')) return;
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.adminDeleteFeedEvent(eventId, token);
      loadAdminFeed();
    } catch(err){
      alert('Error deleting feed event: ' + (err.message || 'Try again'));
    }
  };

  /* â”€â”€ Helpers â”€â”€ */
  function escapeHtml(str){
    return snSanitize.html(str);
  }

  /* â”€â”€ Listen for auth ready event â”€â”€ */
  window.addEventListener('snauth:ready', function(e){
    if(e.detail && e.detail.profile && e.detail.profile.role === 'admin'){
      showSection('adminContent');
      loadHostsList();
      loadUsers();
    }
  });

  // Boot
  initAdminPage();
})();
</script>
</body>
</html>
