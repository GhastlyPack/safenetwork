<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin Panel | Safe Network</title>
<link rel="icon" href="https://res.cloudinary.com/dqn1tnmhl/image/upload/v1771979447/SN_ico_remukb.png"/>
<meta name="robots" content="noindex,nofollow"/>
<link rel="stylesheet" href="/css/global.css">
<link rel="stylesheet" href="/css/auth.css">
<link rel="stylesheet" href="/css/profile.css">
<link rel="stylesheet" href="/css/cookies.css">
<script src="/js/sanitize.js"></script>
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">
    <img src="https://images.whatnot.com/fit-in/3840x0/filters:format(webp)/users%2F52444196%2Fb252b0ef-b6ce-4c9f-ba86-18ffd423776f.png" alt="Safe Network"/>
    <span>SAFE NETWORK</span>
  </a>
  <ul class="nav-links">
    <li><a href="/#shows">Shows</a></li>
    <li><a href="/#host">Hosts</a></li>
    <li><a href="https://www.whatnot.com/user/safenetwork" target="_blank">Watch Live</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/schedule.html">Schedule</a></li>
    <li class="nav-secondary"><a href="/#socials">Links</a></li>
  </ul>
  <button id="authLoginBtn" class="auth-login-btn" onclick="window.snAuth && snAuth.login()">Log In</button>
  <div id="authProfileWrap" class="auth-profile-wrap">
    <div class="auth-avatar" onclick="snAuth.toggleProfileDropdown()">
      <img id="authAvatarImg" alt="Profile"/>
      <span id="authAvatarInitials" class="auth-avatar-initials"></span>
    </div>
    <div id="authDropdown" class="auth-dropdown">
      <div class="auth-dropdown-label">Signed in as</div>
      <div id="authDropdownEmail" class="auth-dropdown-email"></div>
      <button class="auth-logout-btn" onclick="snAuth.logout()">Log Out</button>
    </div>
  </div>
  <button class="hamburger" onclick="toggleMenu()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
</nav>

<ul class="mobile-menu" id="mobileMenu">
  <li><a href="/#shows">Shows</a></li>
  <li><a href="/#host">Hosts</a></li>
  <li><a href="https://www.whatnot.com/user/safenetwork" target="_blank">Watch Live</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/schedule.html">Schedule</a></li>
  <li><a href="/#socials">Links</a></li>
  <li id="authMobileLogin" class="auth-mobile-login"><a href="#" onclick="event.preventDefault();window.snAuth && snAuth.login()">Log In</a></li>
  <li id="authMobileProfile" class="auth-mobile-profile">
    <div class="auth-mobile-signed-in">Signed in as <span id="authMobileEmail" class="auth-mobile-email"></span></div>
    <button class="auth-mobile-logout" onclick="snAuth.logout()">Log Out</button>
  </li>
</ul>

<!-- Loading State -->
<div class="admin-wrap" id="adminLoading">
  <div class="profile-loading">
    <p>Checking access...</p>
  </div>
</div>

<!-- Access Denied -->
<div class="admin-wrap" id="adminDenied" style="display:none">
  <div class="admin-denied">
    <h1>Access Denied</h1>
    <p>You don't have permission to view this page. This area is restricted to Safe Network team members.</p>
    <a href="/" class="btn-primary" style="display:inline-block;text-decoration:none;padding:14px 36px;border-radius:10px">Back to Home</a>
  </div>
</div>

<!-- Admin Content -->
<div class="admin-wrap" id="adminContent" style="display:none">
  <h1>Admin Panel</h1>
  <p style="color:var(--silver);font-size:14px;margin-bottom:24px">Manage users, roles, loyalty, and wishlists for the Safe Network.</p>

  <!-- Tab Navigation -->
  <div class="admin-tabs">
    <button class="admin-tab active" id="tabUsers" onclick="switchAdminTab('users')">Users</button>
    <button class="admin-tab" id="tabWishes" onclick="switchAdminTab('wishes')">Wishes</button>
    <button class="admin-tab" id="tabSchedule" onclick="switchAdminTab('schedule')">Schedule</button>
    <button class="admin-tab" id="tabCollections" onclick="switchAdminTab('collections')">Collections</button>
    <button class="admin-tab" id="tabFeed" onclick="switchAdminTab('feed')">Feed</button>
    <button class="admin-tab" id="tabInventory" onclick="switchAdminTab('inventory')">Inventory</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê Users Tab ‚ïê‚ïê‚ïê -->
  <div id="adminTabUsers">

  <!-- Stats Summary -->
  <div class="admin-stats" id="adminStats">
    <div class="stat-card blue">
      <div class="stat-number" id="statTotal">-</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card green">
      <div class="stat-number" id="statShoppers">-</div>
      <div class="stat-label">Shoppers</div>
    </div>
    <div class="stat-card gold">
      <div class="stat-number" id="statHosts">-</div>
      <div class="stat-label">Hosts</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-number" id="statAdmins">-</div>
      <div class="stat-label">Admins</div>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="admin-search">
    <input type="text" id="adminSearchInput" placeholder="Search by username, email, or name..." oninput="debounceSearch()"/>
    <select class="admin-filter" id="adminRoleFilter" onchange="loadUsers()">
      <option value="">All Roles</option>
      <option value="shopper">Shoppers</option>
      <option value="host">Hosts</option>
      <option value="admin">Admins</option>
    </select>
  </div>

  <!-- Users Table -->
  <div class="admin-table-wrap">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Tier</th>
          <th>Points</th>
          <th>Joined</th>
        </tr>
      </thead>
      <tbody id="adminTableBody">
        <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">Loading users...</td></tr>
      </tbody>
    </table>
  </div>

  </div><!-- /adminTabUsers -->

  <!-- ‚ïê‚ïê‚ïê Wishes Tab ‚ïê‚ïê‚ïê -->
  <div id="adminTabWishes" style="display:none">

    <!-- Wish Stats -->
    <div class="admin-stats">
      <div class="stat-card blue">
        <div class="stat-number" id="wishStatTotal">-</div>
        <div class="stat-label">Total Wishes</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-number" id="wishStatCoins">-</div>
        <div class="stat-label">Coins</div>
      </div>
      <div class="stat-card" style="background:rgba(255,107,107,.06);border-color:rgba(255,107,107,.15)">
        <div class="stat-number" id="wishStatPokemon" style="color:#ff6b6b">-</div>
        <div class="stat-label">Pokemon</div>
      </div>
      <div class="stat-card green">
        <div class="stat-number" id="wishStatSports">-</div>
        <div class="stat-label">Sports Cards</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="admin-search">
      <input type="text" id="wishSearchInput" placeholder="Search wishes by description..." oninput="debounceWishSearch()"/>
      <select class="admin-filter" id="wishCategoryFilter" onchange="loadWishes()">
        <option value="">All Categories</option>
        <option value="coins">Coins &amp; Bullion</option>
        <option value="pokemon">Pokemon</option>
        <option value="sports_cards">Sports Cards</option>
        <option value="shoes">Shoes</option>
      </select>
    </div>

    <!-- Wishes Table -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Category</th>
            <th>Details</th>
            <th>User</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="wishTableBody">
          <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--silver)">Loading wishes...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabWishes -->

  <!-- ‚ïê‚ïê‚ïê Schedule Tab ‚ïê‚ïê‚ïê -->
  <div id="adminTabSchedule" style="display:none">

    <!-- Create Show Form -->
    <div style="background:rgba(255,255,255,.03);border:1px solid rgba(30,144,255,.15);border-radius:16px;padding:24px;margin-bottom:28px">
      <h3 style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;margin-bottom:16px">Schedule a Show</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="admin-edit-field" style="margin:0">
          <label>Host</label>
          <select id="schedHostSlug"></select>
        </div>
        <div class="admin-edit-field" style="margin:0">
          <label>Show Type</label>
          <select id="schedShowType">
            <option value="coins">ü™ô Coins &amp; Bullion</option>
            <option value="pokemon">‚ö° Pokemon</option>
            <option value="sports">üèÄ Sports Cards</option>
            <option value="shoes">üëü Shoes</option>
          </select>
        </div>
      </div>
      <div class="admin-edit-field" style="margin:0 0 12px">
        <label>Title</label>
        <input type="text" id="schedTitle" placeholder="e.g. Coins &amp; Bullion Live Auction" style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="admin-edit-field" style="margin:0">
          <label>Date &amp; Time</label>
          <input type="datetime-local" id="schedDateTime" style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none;color-scheme:dark"/>
        </div>
        <div class="admin-edit-field" style="margin:0">
          <label>Duration (min)</label>
          <input type="number" id="schedDuration" value="60" min="15" max="480" style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
        </div>
        <div class="admin-edit-field" style="margin:0">
          <label>Whatnot URL (optional)</label>
          <input type="url" id="schedWhatnotUrl" placeholder="https://www.whatnot.com/..." style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
        </div>
      </div>
      <div class="admin-edit-field" style="margin:0 0 16px">
        <label>Description (optional)</label>
        <input type="text" id="schedDesc" placeholder="Brief description of this show..." style="width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 14px;color:var(--white);font-family:'Inter',sans-serif;font-size:14px;outline:none"/>
      </div>
      <button class="admin-save-btn" id="schedCreateBtn" onclick="createShow()" style="margin:0">Create Show</button>
      <span id="schedCreateStatus" style="margin-left:12px;font-size:13px"></span>
    </div>

    <!-- Scheduled Shows List -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Title</th>
            <th>Host</th>
            <th>Type</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="schedTableBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">Loading shows...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabSchedule -->

  <!-- ‚ïê‚ïê‚ïê Collections Tab ‚ïê‚ïê‚ïê -->
  <div id="adminTabCollections" style="display:none">

    <!-- Collection Stats -->
    <div class="admin-stats">
      <div class="stat-card blue">
        <div class="stat-number" id="collStatTotal">-</div>
        <div class="stat-label">Total Items</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-number" id="collStatCoins">-</div>
        <div class="stat-label">Coins</div>
      </div>
      <div class="stat-card" style="background:rgba(255,107,107,.06);border-color:rgba(255,107,107,.15)">
        <div class="stat-number" id="collStatPokemon" style="color:#ff6b6b">-</div>
        <div class="stat-label">Pokemon</div>
      </div>
      <div class="stat-card green">
        <div class="stat-number" id="collStatSports">-</div>
        <div class="stat-label">Sports Cards</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="admin-search">
      <input type="text" id="collSearchInput" placeholder="Search collection items by description..." oninput="debounceCollSearch()"/>
      <select class="admin-filter" id="collCategoryFilter" onchange="loadAdminCollections()">
        <option value="">All Categories</option>
        <option value="coins">Coins &amp; Bullion</option>
        <option value="pokemon">Pokemon</option>
        <option value="sports_cards">Sports Cards</option>
        <option value="shoes">Shoes</option>
      </select>
    </div>

    <!-- Collections Table -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Photos</th>
            <th>Description</th>
            <th>Category</th>
            <th>Details</th>
            <th>User</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="collTableBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">Loading collections...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabCollections -->

  <!-- ‚ïê‚ïê‚ïê Feed Tab ‚ïê‚ïê‚ïê -->
  <div id="adminTabFeed" style="display:none">

    <!-- Feed Stats -->
    <div class="admin-stats">
      <div class="stat-card blue">
        <div class="stat-number" id="feedStatTotal">-</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-card green">
        <div class="stat-number" id="feedStatWishlist">-</div>
        <div class="stat-label">Wishlists</div>
      </div>
      <div class="stat-card gold">
        <div class="stat-number" id="feedStatCollection">-</div>
        <div class="stat-label">Collections</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-number" id="feedStatInventory">-</div>
        <div class="stat-label">Inventory</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="admin-search">
      <select class="admin-filter" id="feedTypeFilter" onchange="loadAdminFeed()">
        <option value="">All Types</option>
        <option value="wishlist">Wishlists</option>
        <option value="collection">Collections</option>
        <option value="inventory">Inventory</option>
      </select>
      <select class="admin-filter" id="feedCatFilter" onchange="loadAdminFeed()">
        <option value="">All Categories</option>
        <option value="coins">Coins &amp; Bullion</option>
        <option value="pokemon">Pokemon</option>
        <option value="sports_cards">Sports Cards</option>
        <option value="shoes">Shoes</option>
      </select>
    </div>

    <!-- Feed Table -->
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Author</th>
            <th>Category</th>
            <th>Description</th>
            <th style="text-align:center">Reactions</th>
            <th style="text-align:center">Comments</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="feedTableBody">
          <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--silver)">Loading feed events...</td></tr>
        </tbody>
      </table>
    </div>

  </div><!-- /adminTabFeed -->

  <!-- ‚ïê‚ïê‚ïê Inventory Tab ‚ïê‚ïê‚ïê -->
  <div id="adminTabInventory" style="display:none">

    <!-- Sub-Tab Navigation -->
    <div class="inv-subtabs">
      <button class="inv-subtab active" data-inv-tab="dashboard" onclick="switchInvTab('dashboard')">Dashboard</button>
      <button class="inv-subtab" data-inv-tab="coins" onclick="switchInvTab('coins')">Coins</button>
      <button class="inv-subtab" data-inv-tab="bullion" onclick="switchInvTab('bullion')">Bullion</button>
      <button class="inv-subtab" data-inv-tab="pokemon" onclick="switchInvTab('pokemon')">Pokemon</button>
      <button class="inv-subtab" data-inv-tab="sports" onclick="switchInvTab('sports')">Sports</button>
      <button class="inv-subtab" data-inv-tab="wheel" onclick="switchInvTab('wheel')">Wheel Builder</button>
      <button class="inv-subtab" data-inv-tab="breaks" onclick="switchInvTab('breaks')">Break Calc</button>
    </div>

    <!-- ‚îÄ‚îÄ Dashboard Sub-Tab ‚îÄ‚îÄ -->
    <div id="invDashboard" class="inv-panel">

      <!-- Spot Prices -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h3 style="color:var(--gold2);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin:0">Spot Prices</h3>
        <button class="btn-primary" style="font-size:12px;padding:8px 16px" onclick="refreshSpotPrices()">&#x21bb; Refresh Prices</button>
      </div>
      <div class="admin-stats" id="invSpotPrices">
        <div class="stat-card gold">
          <div class="stat-number" id="spotGold">-</div>
          <div class="stat-label">Gold / oz</div>
        </div>
        <div class="stat-card" style="background:rgba(192,200,216,.06);border-color:rgba(192,200,216,.15)">
          <div class="stat-number" id="spotSilver" style="color:var(--silver)">-</div>
          <div class="stat-label">Silver / oz</div>
        </div>
        <div class="stat-card" style="background:rgba(192,200,216,.06);border-color:rgba(192,200,216,.15)">
          <div class="stat-number" id="spotPlatinum" style="color:#e5e7eb">-</div>
          <div class="stat-label">Platinum / oz</div>
        </div>
        <div class="stat-card" style="background:rgba(192,200,216,.06);border-color:rgba(192,200,216,.15)">
          <div class="stat-number" id="spotPalladium" style="color:#e5e7eb">-</div>
          <div class="stat-label">Palladium / oz</div>
        </div>
      </div>
      <div id="spotUpdatedAt" style="color:var(--silver);font-size:11px;margin-bottom:24px;text-align:right"></div>

      <!-- Combined P&L Stats -->
      <h3 style="color:var(--blue);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:16px">Inventory Overview</h3>
      <div class="admin-stats" id="invOverviewStats">
        <div class="stat-card blue">
          <div class="stat-number" id="invStatTotal">-</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card green">
          <div class="stat-number" id="invStatInStock">-</div>
          <div class="stat-label">In Stock</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-number" id="invStatListed">-</div>
          <div class="stat-label">Listed</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-number" id="invStatSold">-</div>
          <div class="stat-label">Sold</div>
        </div>
      </div>
      <div class="admin-stats">
        <div class="stat-card green">
          <div class="stat-number" id="invStatTotalCost">-</div>
          <div class="stat-label">Total Cost</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-number" id="invStatTotalRevenue">-</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card" style="background:rgba(74,222,128,.06);border-color:rgba(74,222,128,.15)">
          <div class="stat-number" id="invStatNetProfit" style="color:#4ade80">-</div>
          <div class="stat-label">Net Profit</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-number" id="invStatMargin">-</div>
          <div class="stat-label">Margin %</div>
        </div>
      </div>

      <!-- Per-Category Breakdown -->
      <h3 style="color:var(--blue);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin:24px 0 16px">Category Breakdown</h3>
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Items</th>
              <th>In Stock</th>
              <th>Sold</th>
              <th>Total Cost</th>
              <th>Revenue</th>
              <th>Net Profit</th>
            </tr>
          </thead>
          <tbody id="invBreakdownBody">
            <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--silver)">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Category Sub-Tabs (Coins, Bullion, Pokemon, Sports) ‚îÄ‚îÄ -->
    <div id="invCoins" class="inv-panel" style="display:none"></div>
    <div id="invBullion" class="inv-panel" style="display:none"></div>
    <div id="invPokemon" class="inv-panel" style="display:none"></div>
    <div id="invSports" class="inv-panel" style="display:none"></div>

    <!-- ‚îÄ‚îÄ Wheel Builder Sub-Tab ‚îÄ‚îÄ -->
    <div id="invWheel" class="inv-panel" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
        <h3 style="color:var(--gold2);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin:0">Wheel Builder</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-primary" style="font-size:12px;padding:8px 16px" onclick="wheelAddPrize()">+ Add Prize</button>
          <button class="btn-primary" style="font-size:12px;padding:8px 16px;background:rgba(74,222,128,.15);color:#4ade80" onclick="wheelSaveConfig()">Save Config</button>
          <button class="btn-primary" style="font-size:12px;padding:8px 16px;background:rgba(192,200,216,.1);color:var(--silver)" onclick="wheelLoadConfig()">Load Config</button>
        </div>
      </div>

      <!-- Spin Price -->
      <div class="inv-form-grid" style="margin-bottom:20px">
        <div class="inv-form-field">
          <label>Spin Price ($)</label>
          <input type="number" id="wheelSpinPrice" min="0" step="0.01" value="10" oninput="wheelRecalc()"/>
        </div>
        <div class="inv-form-field">
          <label>Total Slots</label>
          <div id="wheelTotalSlots" style="color:var(--blue);font-size:20px;font-weight:700;padding:10px 0">0</div>
        </div>
        <div class="inv-form-field">
          <label>Total Prize Cost</label>
          <div id="wheelTotalCost" style="color:var(--gold2);font-size:20px;font-weight:700;padding:10px 0">$0.00</div>
        </div>
      </div>

      <!-- Prize Table -->
      <div class="admin-table-wrap" style="margin-bottom:20px">
        <table class="admin-table" id="wheelPrizeTable">
          <thead>
            <tr>
              <th>Prize Name</th>
              <th>Value ($)</th>
              <th>Slots</th>
              <th>Probability</th>
              <th>EV Contribution</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="wheelPrizeBody">
            <tr><td colspan="6" style="text-align:center;padding:20px;color:var(--silver)">No prizes added yet. Click "+ Add Prize" to begin.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Profitability Analysis -->
      <h3 style="color:var(--blue);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:16px">Profitability Analysis</h3>
      <div class="admin-stats">
        <div class="stat-card blue">
          <div class="stat-number" id="wheelRevPerCycle">-</div>
          <div class="stat-label">Revenue / Cycle</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-number" id="wheelCostPerCycle">-</div>
          <div class="stat-label">Cost / Cycle</div>
        </div>
        <div class="stat-card green">
          <div class="stat-number" id="wheelProfitPerCycle">-</div>
          <div class="stat-label">Profit / Cycle</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-number" id="wheelMargin">-</div>
          <div class="stat-label">Margin %</div>
        </div>
      </div>
      <div class="admin-stats" style="margin-top:16px">
        <div class="stat-card blue">
          <div class="stat-number" id="wheelEV">-</div>
          <div class="stat-label">Expected Value</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-number" id="wheelHouseEdge">-</div>
          <div class="stat-label">House Edge</div>
        </div>
        <div class="stat-card green">
          <div class="stat-number" id="wheelBreakEven">-</div>
          <div class="stat-label">Break-Even Price</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Break Calculator Sub-Tab ‚îÄ‚îÄ -->
    <div id="invBreaks" class="inv-panel" style="display:none">
      <div class="inv-subtabs" style="margin-bottom:20px">
        <button class="inv-subtab active" data-break-tab="random" onclick="switchBreakTab('random')">Random Pack Break</button>
        <button class="inv-subtab" data-break-tab="pickteam" onclick="switchBreakTab('pickteam')">Pick Your Team</button>
      </div>

      <!-- Random Pack Break -->
      <div id="breakRandom" class="inv-panel">
        <h3 style="color:var(--gold2);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:16px">Random Pack Break</h3>
        <div class="inv-form-grid" style="margin-bottom:20px">
          <div class="inv-form-field">
            <label>Box/Product Cost ($)</label>
            <input type="number" id="breakBoxCost" min="0" step="0.01" value="200" oninput="calcRandomBreak()"/>
          </div>
          <div class="inv-form-field">
            <label>Number of Slots</label>
            <input type="number" id="breakSlots" min="1" step="1" value="10" oninput="calcRandomBreak()"/>
          </div>
          <div class="inv-form-field">
            <label>Margin Preset</label>
            <select id="breakMarginPreset" onchange="calcRandomBreak()">
              <option value="0">Break Even (0%)</option>
              <option value="10">Low (10%)</option>
              <option value="20" selected>Standard (20%)</option>
              <option value="30">High (30%)</option>
              <option value="50">Premium (50%)</option>
              <option value="custom">Custom...</option>
            </select>
          </div>
          <div class="inv-form-field" id="breakCustomMarginWrap" style="display:none">
            <label>Custom Margin %</label>
            <input type="number" id="breakCustomMargin" min="0" max="200" step="1" value="25" oninput="calcRandomBreak()"/>
          </div>
        </div>
        <div class="admin-stats">
          <div class="stat-card blue">
            <div class="stat-number" id="breakCostPerSlot">-</div>
            <div class="stat-label">Cost / Slot</div>
          </div>
          <div class="stat-card gold">
            <div class="stat-number" id="breakPricePerSlot">-</div>
            <div class="stat-label">Price / Slot</div>
          </div>
          <div class="stat-card green">
            <div class="stat-number" id="breakTotalRevenue">-</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-number" id="breakTotalProfit">-</div>
            <div class="stat-label">Profit</div>
          </div>
        </div>
      </div>

      <!-- Pick Your Team Break -->
      <div id="breakPickTeam" class="inv-panel" style="display:none">
        <h3 style="color:var(--gold2);font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:16px">Pick Your Team Break</h3>
        <div class="inv-form-grid" style="margin-bottom:16px">
          <div class="inv-form-field">
            <label>Box/Product Cost ($)</label>
            <input type="number" id="pytBoxCost" min="0" step="0.01" value="500" oninput="calcPYTBreak()"/>
          </div>
          <div class="inv-form-field">
            <label>Target Margin %</label>
            <input type="number" id="pytMargin" min="0" max="200" step="1" value="20" oninput="calcPYTBreak()"/>
          </div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <span style="color:var(--silver);font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px">Teams / Slots</span>
          <button class="btn-primary" style="font-size:12px;padding:6px 14px" onclick="pytAddTeam()">+ Add Team</button>
        </div>
        <div class="admin-table-wrap" style="margin-bottom:20px">
          <table class="admin-table" id="pytTeamTable">
            <thead>
              <tr>
                <th>Team Name</th>
                <th>Weight</th>
                <th>Auto Price</th>
                <th>Override ($)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="pytTeamBody">
              <tr><td colspan="5" style="text-align:center;padding:20px;color:var(--silver)">No teams added yet. Click "+ Add Team" to begin.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="admin-stats">
          <div class="stat-card blue">
            <div class="stat-number" id="pytTotalWeight">-</div>
            <div class="stat-label">Total Weight</div>
          </div>
          <div class="stat-card gold">
            <div class="stat-number" id="pytTargetRevenue">-</div>
            <div class="stat-label">Target Revenue</div>
          </div>
          <div class="stat-card green">
            <div class="stat-number" id="pytActualRevenue">-</div>
            <div class="stat-label">Actual Revenue</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-number" id="pytActualProfit">-</div>
            <div class="stat-label">Actual Profit</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /adminTabInventory -->

  <!-- Inventory Add/Edit Panel (slide from right) -->
  <div class="admin-edit-overlay" id="invEditOverlay" onclick="closeInvEditPanel(event)">
    <div class="admin-edit-panel" onclick="event.stopPropagation()">
      <button class="admin-edit-close" onclick="closeInvEditPanel()">&times;</button>
      <h2 id="invEditTitle">Add Item</h2>

      <div class="inv-form-grid">
        <div class="inv-form-field full">
          <label>Name *</label>
          <input type="text" id="invName" placeholder="Item name or description"/>
        </div>
        <div class="inv-form-field">
          <label>Category</label>
          <select id="invCategory" onchange="updateInvDetailFields()">
            <option value="coins">Coins</option>
            <option value="bullion">Bullion</option>
            <option value="pokemon_cards">Pokemon Cards</option>
            <option value="pokemon_sealed">Pokemon Sealed</option>
            <option value="sports_cards">Sports Cards</option>
          </select>
        </div>
        <div class="inv-form-field">
          <label>Status</label>
          <select id="invStatus">
            <option value="in_stock">In Stock</option>
            <option value="listed">Listed</option>
            <option value="sold">Sold</option>
            <option value="returned">Returned</option>
            <option value="held">Held</option>
          </select>
        </div>
        <div class="inv-form-field">
          <label>Purchase Date</label>
          <input type="date" id="invPurchaseDate"/>
        </div>
        <div class="inv-form-field">
          <label>Purchase Price ($)</label>
          <input type="number" id="invPurchasePrice" min="0" step="0.01"/>
        </div>
        <div class="inv-form-field">
          <label>Buyer's Premium ($)</label>
          <input type="number" id="invBuyersPremium" min="0" step="0.01" value="0"/>
        </div>
        <div class="inv-form-field">
          <label>Source / Seller</label>
          <input type="text" id="invSource" placeholder="Auction house, dealer, etc."/>
        </div>
        <div class="inv-form-field">
          <label>Market Value ($)</label>
          <input type="number" id="invMarketValue" min="0" step="0.01"/>
        </div>
        <div class="inv-form-field">
          <label>Listed on Whatnot?</label>
          <select id="invListedWhatnot">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="inv-form-field">
          <label>Stream Date</label>
          <input type="date" id="invStreamDate"/>
        </div>
        <div class="inv-form-field">
          <label>Starting Bid ($)</label>
          <input type="number" id="invStartingBid" min="0" step="0.01"/>
        </div>
        <div class="inv-form-field">
          <label>Final Sale Price ($)</label>
          <input type="number" id="invFinalSalePrice" min="0" step="0.01"/>
        </div>
        <div class="inv-form-field">
          <label>Sale Fees ($)</label>
          <input type="number" id="invSaleFees" min="0" step="0.01"/>
        </div>
        <div class="inv-form-field full">
          <label>Notes</label>
          <textarea id="invNotes" rows="3" placeholder="Additional notes..."></textarea>
        </div>
      </div>

      <!-- Dynamic Category-Specific Fields -->
      <div id="invDetailFields" style="margin-top:16px"></div>

      <div style="display:flex;gap:12px;margin-top:24px">
        <button class="btn-primary" style="flex:1;padding:14px" onclick="saveInventoryItem()">Save Item</button>
        <button class="btn-primary" style="flex:1;padding:14px;background:rgba(192,200,216,.1);color:var(--silver)" onclick="closeInvEditPanel()">Cancel</button>
      </div>
    </div>
  </div>

</div>

<!-- Price Lookup Panel (slide from right) -->
<div class="admin-edit-overlay" id="priceLookupOverlay" onclick="closePriceLookup(event)">
  <div class="admin-edit-panel" style="max-width:800px" onclick="event.stopPropagation()">
    <button class="admin-edit-close" onclick="closePriceLookup()">&times;</button>
    <h2 style="color:var(--gold2)">&#x1F50D; JustTCG Price Lookup</h2>
    <div style="margin-bottom:12px">
      <div class="admin-search">
        <input type="text" id="priceLookupInput" placeholder="Search cards..." onkeydown="if(event.key==='Enter'){searchJustTCGFromPanel()}"/>
        <button class="btn-primary" style="padding:10px 20px;font-size:13px;white-space:nowrap" onclick="searchJustTCGFromPanel()">Search</button>
      </div>
    </div>
    <div class="admin-table-wrap">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Card Name</th>
            <th>Set</th>
            <th>#</th>
            <th>Price</th>
            <th>7d</th>
            <th>30d</th>
            <th>Variant</th>
          </tr>
        </thead>
        <tbody id="priceLookupBody">
          <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--silver)">Enter a card name above and hit Search.</td></tr>
        </tbody>
      </table>
    </div>
    <div id="priceLookupMeta" style="color:var(--silver);font-size:11px;margin-top:8px;text-align:right"></div>
  </div>
</div>

<!-- Edit User Panel (slide from right) -->
<div class="admin-edit-overlay" id="adminEditOverlay" onclick="closeEditPanel(event)">
  <div class="admin-edit-panel" onclick="event.stopPropagation()">
    <button class="admin-edit-close" onclick="closeEditPanel()">&times;</button>
    <h2>Edit User</h2>

    <div style="margin-bottom:20px;padding:16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px">
      <div style="color:var(--silver);font-size:12px;margin-bottom:4px">Username</div>
      <div id="editUsername" style="color:var(--blue);font-weight:600;font-size:16px">-</div>
      <div style="color:var(--silver);font-size:12px;margin-top:8px">Email</div>
      <div id="editEmail" style="color:var(--silver);font-size:14px">-</div>
    </div>

    <div class="admin-edit-field">
      <label>Role</label>
      <select id="editRole" onchange="onRoleChange()">
        <option value="shopper">Shopper</option>
        <option value="host">Host</option>
        <option value="admin">Admin</option>
      </select>
    </div>

    <div class="admin-edit-field" id="hostPickerField" style="display:none">
      <label>Linked Host</label>
      <select id="editHostSlug">
        <option value="">-- None --</option>
      </select>
    </div>

    <div class="admin-edit-field">
      <label>Loyalty Tier</label>
      <select id="editTier">
        <option value="bronze">Bronze</option>
        <option value="silver">Silver</option>
        <option value="gold">Gold</option>
        <option value="diamond">Diamond</option>
      </select>
    </div>

    <div class="admin-edit-field">
      <label>Loyalty Points</label>
      <input type="number" id="editPoints" min="0" step="1"/>
    </div>

    <button class="admin-save-btn" id="adminSaveBtn" onclick="saveUserEdits()">Save Changes</button>
    <div class="admin-edit-status" id="adminEditStatus"></div>
  </div>
</div>

<footer>
  <div class="footer-logo">SAFE NETWORK</div>
  <div><a href="/privacy.html">Privacy Policy</a> ¬∑ <a href="/terms.html">Terms of Service</a></div>
  <p>2026 Safe Network ¬∑ safenetwork.shop</p>
</footer>

<script>
  function toggleMenu(){
    document.getElementById('mobileMenu').classList.toggle('open');
    document.querySelector('.hamburger').classList.toggle('open');
  }
</script>
<script src="/js/supabase.js"></script>
<script src="/js/cookies.js"></script>
<script src="/js/auth.js"></script>
<script>
/* ‚îÄ‚îÄ Admin Page Logic ‚îÄ‚îÄ */
(function(){
  var allUsers = [];
  var editingUser = null;
  var searchTimer = null;
  var hostsList = [];

  /* ‚îÄ‚îÄ Initialize Admin Page ‚îÄ‚îÄ */
  async function initAdminPage(){
    var maxWait = 50;
    while(!window.snAuth && maxWait > 0){
      await new Promise(function(r){ setTimeout(r, 100); });
      maxWait--;
    }

    if(!window.snAuth){
      showSection('adminDenied');
      return;
    }

    var loggedIn = await snAuth.isLoggedIn();
    if(!loggedIn){
      showSection('adminDenied');
      return;
    }

    // Check if user is admin
    var profile = window.snProfile ? snProfile.getCachedProfile() : null;
    if(!profile){
      try {
        var user = await snAuth.getUser();
        var token = await snAuth.getAccessToken();
        if(user && token && window.snProfile){
          profile = await snProfile.initProfile(user, token);
        }
      } catch(err){
        console.warn('Admin profile check error:', err);
      }
    }

    if(!profile || (profile.role !== 'admin' && profile.role !== 'host')){
      showSection('adminDenied');
      return;
    }

    // Show panel
    showSection('adminContent');

    if(profile.role === 'host'){
      // Hosts only see the Inventory tab - hide all other tabs
      document.getElementById('tabUsers').style.display = 'none';
      document.getElementById('tabWishes').style.display = 'none';
      document.getElementById('tabSchedule').style.display = 'none';
      document.getElementById('tabCollections').style.display = 'none';
      document.getElementById('tabFeed').style.display = 'none';
      // Auto-switch to inventory
      switchAdminTab('inventory');
    } else {
      // Admin - load everything
      loadHostsList();
      loadUsers();
    }
  }

  function showSection(id){
    document.getElementById('adminLoading').style.display = 'none';
    document.getElementById('adminDenied').style.display = 'none';
    document.getElementById('adminContent').style.display = 'none';
    document.getElementById(id).style.display = '';
  }

  /* ‚îÄ‚îÄ Load Hosts List ‚îÄ‚îÄ */
  async function loadHostsList(){
    try {
      hostsList = await snProfile.listHosts();
      var select = document.getElementById('editHostSlug');
      // Clear existing options beyond the default
      select.innerHTML = '<option value="">-- None --</option>';
      hostsList.forEach(function(h){
        var opt = document.createElement('option');
        opt.value = h.slug;
        opt.textContent = h.name;
        select.appendChild(opt);
      });
    } catch(err){
      console.warn('Load hosts error:', err);
    }
  }

  /* ‚îÄ‚îÄ Role Change Handler ‚îÄ‚îÄ */
  window.onRoleChange = function(){
    var role = document.getElementById('editRole').value;
    document.getElementById('hostPickerField').style.display = role === 'host' ? '' : 'none';
  };

  /* ‚îÄ‚îÄ Load Users ‚îÄ‚îÄ */
  window.loadUsers = async function(){
    var search = document.getElementById('adminSearchInput').value.trim();
    var roleFilter = document.getElementById('adminRoleFilter').value;

    try {
      var token = await snAuth.getAccessToken();
      allUsers = await snProfile.adminListUsers(token, search, roleFilter);
      renderUsers();
      updateStats();
    } catch(err){
      console.warn('Load users error:', err);
      var tbody = document.getElementById('adminTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#ff6b6b">Error loading users. Please try again.</td></tr>';
    }
  };

  /* ‚îÄ‚îÄ Render Users Table ‚îÄ‚îÄ */
  function renderUsers(){
    var tbody = document.getElementById('adminTableBody');
    if(!allUsers.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">No users found.</td></tr>';
      return;
    }

    var html = '';
    allUsers.forEach(function(u, idx){
      var joined = u.created_at ? new Date(u.created_at).toLocaleDateString() : '-';
      var safeRole = escapeHtml(u.role || 'shopper');
      var safeTier = escapeHtml(u.loyalty_tier || 'bronze');
      html += '<tr class="user-row" data-user-idx="' + idx + '">' +
        '<td class="username-cell">@' + escapeHtml(u.username || '') + '</td>' +
        '<td>' + escapeHtml(u.email || '') + '</td>' +
        '<td><span class="profile-badge badge-' + safeRole + '">' + safeRole + '</span></td>' +
        '<td><span class="profile-badge badge-' + safeTier + '">' + safeTier + '</span></td>' +
        '<td>' + (parseInt(u.loyalty_points, 10) || 0) + '</td>' +
        '<td>' + joined + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
    // Attach click handlers via event delegation (safe - no inline JS injection)
    tbody.querySelectorAll('.user-row').forEach(function(row){
      row.addEventListener('click', function(){
        var idx = parseInt(row.getAttribute('data-user-idx'), 10);
        if(allUsers[idx]) openEditPanel(JSON.stringify(allUsers[idx]));
      });
    });
  }

  /* ‚îÄ‚îÄ Update Stats ‚îÄ‚îÄ */
  function updateStats(){
    var total = allUsers.length;
    var shoppers = 0, hosts = 0, admins = 0;
    allUsers.forEach(function(u){
      if(u.role === 'host') hosts++;
      else if(u.role === 'admin') admins++;
      else shoppers++;
    });
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statShoppers').textContent = shoppers;
    document.getElementById('statHosts').textContent = hosts;
    document.getElementById('statAdmins').textContent = admins;
  }

  /* ‚îÄ‚îÄ Search Debounce ‚îÄ‚îÄ */
  window.debounceSearch = function(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(loadUsers, 400);
  };

  /* ‚îÄ‚îÄ Edit Panel ‚îÄ‚îÄ */
  window.openEditPanel = function(userJson){
    editingUser = JSON.parse(userJson);
    document.getElementById('editUsername').textContent = '@' + (editingUser.username || '');
    document.getElementById('editEmail').textContent = editingUser.email || '';
    document.getElementById('editRole').value = editingUser.role || 'shopper';
    document.getElementById('editHostSlug').value = editingUser.host_slug || '';
    document.getElementById('hostPickerField').style.display = (editingUser.role === 'host') ? '' : 'none';
    document.getElementById('editTier').value = editingUser.loyalty_tier || 'bronze';
    document.getElementById('editPoints').value = editingUser.loyalty_points || 0;
    document.getElementById('adminEditStatus').textContent = '';
    document.getElementById('adminEditOverlay').classList.add('open');
  };

  window.closeEditPanel = function(e){
    if(e && e.target !== document.getElementById('adminEditOverlay')) return;
    document.getElementById('adminEditOverlay').classList.remove('open');
    editingUser = null;
  };

  /* ‚îÄ‚îÄ Save User Edits ‚îÄ‚îÄ */
  window.saveUserEdits = async function(){
    if(!editingUser) return;

    var btn = document.getElementById('adminSaveBtn');
    var statusEl = document.getElementById('adminEditStatus');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    statusEl.textContent = '';

    var role = document.getElementById('editRole').value;
    var updates = {
      role: role,
      loyalty_tier: document.getElementById('editTier').value,
      loyalty_points: parseInt(document.getElementById('editPoints').value) || 0
    };

    if(role === 'host'){
      updates.host_slug = document.getElementById('editHostSlug').value || null;
    } else {
      updates.host_slug = null;
    }

    try {
      var token = await snAuth.getAccessToken();
      await snProfile.adminUpdateUser(editingUser.auth0_id, updates, token);
      statusEl.textContent = 'Saved!';
      statusEl.style.color = '#4ade80';

      // Refresh the user list
      setTimeout(function(){
        closeEditPanel();
        loadUsers();
      }, 800);
    } catch(err){
      console.warn('Admin save error:', err);
      statusEl.textContent = 'Error: ' + (err.message || 'Please try again.');
      statusEl.style.color = '#ff6b6b';
    }

    btn.disabled = false;
    btn.textContent = 'Save Changes';
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB SWITCHING + WISHES TAB
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  var allWishes = [];
  var wishesLoaded = false;
  var wishSearchTimer = null;

  var WISH_CATEGORY_LABELS = {
    coins: 'Coins & Bullion',
    pokemon: 'Pokemon',
    sports_cards: 'Sports Cards',
    shoes: 'Shoes'
  };

  window.switchAdminTab = function(tab){
    document.getElementById('adminTabUsers').style.display = tab === 'users' ? '' : 'none';
    document.getElementById('adminTabWishes').style.display = tab === 'wishes' ? '' : 'none';
    document.getElementById('adminTabSchedule').style.display = tab === 'schedule' ? '' : 'none';
    document.getElementById('adminTabCollections').style.display = tab === 'collections' ? '' : 'none';
    document.getElementById('adminTabFeed').style.display = tab === 'feed' ? '' : 'none';
    document.getElementById('adminTabInventory').style.display = tab === 'inventory' ? '' : 'none';
    document.getElementById('tabUsers').classList.toggle('active', tab === 'users');
    document.getElementById('tabWishes').classList.toggle('active', tab === 'wishes');
    document.getElementById('tabSchedule').classList.toggle('active', tab === 'schedule');
    document.getElementById('tabCollections').classList.toggle('active', tab === 'collections');
    document.getElementById('tabFeed').classList.toggle('active', tab === 'feed');
    document.getElementById('tabInventory').classList.toggle('active', tab === 'inventory');
    if(tab === 'wishes' && !wishesLoaded) loadWishes();
    if(tab === 'schedule' && !scheduledShowsLoaded) loadScheduledShows();
    if(tab === 'collections' && !collectionsLoaded) loadAdminCollections();
    if(tab === 'feed' && !feedEventsLoaded) loadAdminFeed();
    if(tab === 'inventory' && !inventoryLoaded) loadInventoryDashboard();
  };

  window.loadWishes = async function(){
    var search = document.getElementById('wishSearchInput').value.trim();
    var category = document.getElementById('wishCategoryFilter').value;
    try {
      var token = await snAuth.getAccessToken();
      allWishes = await snProfile.adminListWishes(token, category, search);
      wishesLoaded = true;
      renderWishes();
      updateWishStats();
    } catch(err){
      console.warn('Load wishes error:', err);
      document.getElementById('wishTableBody').innerHTML =
        '<tr><td colspan="5" style="text-align:center;padding:40px;color:#ff6b6b">Error loading wishes.</td></tr>';
    }
  };

  function renderWishes(){
    var tbody = document.getElementById('wishTableBody');
    if(!allWishes.length){
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--silver)">No wishes found.</td></tr>';
      return;
    }

    var html = '';
    allWishes.forEach(function(w){
      var date = w.created_at ? new Date(w.created_at).toLocaleDateString() : '-';
      var cat = w.category || '';
      var user = w.profiles ? ('@' + escapeHtml(w.profiles.username || '')) : '-';
      var details = w.details || {};
      var detailStr = Object.values(details).map(function(v){
        return escapeHtml(String(v).replace(/_/g, ' '));
      }).join(', ');

      html += '<tr>' +
        '<td style="max-width:300px">' + escapeHtml(w.description || '') + '</td>' +
        '<td><span class="profile-badge badge-' + escapeHtml(cat) + '" style="font-size:10px">' + escapeHtml(WISH_CATEGORY_LABELS[cat] || cat) + '</span></td>' +
        '<td style="font-size:12px;color:var(--silver)">' + (detailStr || '-') + '</td>' +
        '<td style="color:var(--blue);font-weight:600">' + user + '</td>' +
        '<td>' + date + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  function updateWishStats(){
    var total = allWishes.length;
    var coins = 0, pokemon = 0, sports = 0;
    allWishes.forEach(function(w){
      if(w.category === 'coins') coins++;
      else if(w.category === 'pokemon') pokemon++;
      else if(w.category === 'sports_cards') sports++;
    });
    document.getElementById('wishStatTotal').textContent = total;
    document.getElementById('wishStatCoins').textContent = coins;
    document.getElementById('wishStatPokemon').textContent = pokemon;
    document.getElementById('wishStatSports').textContent = sports;
  }

  window.debounceWishSearch = function(){
    clearTimeout(wishSearchTimer);
    wishSearchTimer = setTimeout(loadWishes, 400);
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCHEDULE TAB
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  var scheduledShows = [];
  var scheduledShowsLoaded = false;

  var SHOW_TYPE_LABELS = {
    coins: 'ü™ô Coins & Bullion',
    pokemon: '‚ö° Pokemon',
    sports: 'üèÄ Sports Cards',
    shoes: 'üëü Shoes'
  };

  var STATUS_LABELS = {
    scheduled: 'Scheduled',
    live: 'üî¥ Live',
    completed: 'Completed',
    cancelled: 'Cancelled'
  };

  /* ‚îÄ‚îÄ Load Scheduled Shows ‚îÄ‚îÄ */
  window.loadScheduledShows = async function(){
    try {
      // Populate host picker
      var hostSelect = document.getElementById('schedHostSlug');
      if(hostSelect.options.length <= 1){
        hostSelect.innerHTML = '';
        hostsList.forEach(function(h){
          var opt = document.createElement('option');
          opt.value = h.slug;
          opt.textContent = h.name;
          hostSelect.appendChild(opt);
        });
      }

      var result = await snProfile.listScheduledShows({ include_all: true });
      scheduledShows = result.shows || [];
      scheduledShowsLoaded = true;
      renderScheduledShows();
    } catch(err){
      console.warn('Load scheduled shows error:', err);
      document.getElementById('schedTableBody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;padding:40px;color:#ff6b6b">Error loading shows.</td></tr>';
    }
  };

  function renderScheduledShows(){
    var tbody = document.getElementById('schedTableBody');
    if(!scheduledShows.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">No shows scheduled. Create one above.</td></tr>';
      return;
    }

    // Sort by date descending (newest first)
    scheduledShows.sort(function(a,b){ return new Date(b.scheduled_at) - new Date(a.scheduled_at); });

    var html = '';
    scheduledShows.forEach(function(s){
      var d = new Date(s.scheduled_at);
      var dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      var timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      var typeLabel = SHOW_TYPE_LABELS[s.show_type] || s.show_type;
      var statusLabel = STATUS_LABELS[s.status] || s.status;
      var statusClass = 'badge-' + (s.status === 'live' ? 'live' : s.status === 'cancelled' ? 'soon' : 'shopper');

      var safeId = snSanitize.attr(s.id);
      var actions = '';
      if(s.status === 'scheduled'){
        actions += '<button onclick="updateShowStatus(\'' + safeId + '\',\'live\')" style="background:rgba(34,197,94,.12);color:#4ade80;border:1px solid rgba(34,197,94,.3);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;margin-right:4px">Go Live</button>';
        actions += '<button onclick="updateShowStatus(\'' + safeId + '\',\'cancelled\')" style="background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.2);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">Cancel</button>';
      } else if(s.status === 'live'){
        actions += '<button onclick="updateShowStatus(\'' + safeId + '\',\'completed\')" style="background:rgba(30,144,255,.12);color:var(--blue);border:1px solid rgba(30,144,255,.25);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">End Show</button>';
      } else {
        actions += '<button onclick="deleteShow(\'' + safeId + '\')" style="background:rgba(255,255,255,.04);color:var(--silver);border:1px solid rgba(255,255,255,.1);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">Delete</button>';
      }

      html += '<tr>' +
        '<td style="white-space:nowrap"><div style="font-weight:600">' + dateStr + '</div><div style="font-size:11px;color:var(--silver)">' + timeStr + '</div></td>' +
        '<td style="font-weight:600">' + escapeHtml(s.title || '') + '</td>' +
        '<td style="color:var(--blue);font-weight:600">@' + escapeHtml(s.host_handle || '') + '</td>' +
        '<td style="font-size:12px">' + typeLabel + '</td>' +
        '<td><span class="profile-badge ' + statusClass + '" style="font-size:10px">' + statusLabel + '</span></td>' +
        '<td>' + actions + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  /* ‚îÄ‚îÄ Create Show ‚îÄ‚îÄ */
  window.createShow = async function(){
    var btn = document.getElementById('schedCreateBtn');
    var statusEl = document.getElementById('schedCreateStatus');
    btn.disabled = true;
    btn.textContent = 'Creating...';
    statusEl.textContent = '';

    var dateVal = document.getElementById('schedDateTime').value;
    if(!dateVal){
      statusEl.textContent = 'Please select a date and time';
      statusEl.style.color = '#ff6b6b';
      btn.disabled = false;
      btn.textContent = 'Create Show';
      return;
    }

    var data = {
      host_slug: document.getElementById('schedHostSlug').value,
      show_type: document.getElementById('schedShowType').value,
      title: document.getElementById('schedTitle').value.trim() || (SHOW_TYPE_LABELS[document.getElementById('schedShowType').value] || 'Show'),
      description: document.getElementById('schedDesc').value.trim() || null,
      scheduled_at: new Date(dateVal).toISOString(),
      duration_minutes: parseInt(document.getElementById('schedDuration').value) || 60,
      whatnot_url: document.getElementById('schedWhatnotUrl').value.trim() || null
    };

    try {
      var token = await snAuth.getAccessToken();
      await snProfile.createScheduledShow(data, token);
      statusEl.textContent = 'Show created!';
      statusEl.style.color = '#4ade80';
      // Clear form
      document.getElementById('schedTitle').value = '';
      document.getElementById('schedDesc').value = '';
      document.getElementById('schedDateTime').value = '';
      document.getElementById('schedWhatnotUrl').value = '';
      // Reload list
      loadScheduledShows();
    } catch(err){
      statusEl.textContent = 'Error: ' + (err.message || 'Try again');
      statusEl.style.color = '#ff6b6b';
    }

    btn.disabled = false;
    btn.textContent = 'Create Show';
  };

  /* ‚îÄ‚îÄ Update Show Status ‚îÄ‚îÄ */
  window.updateShowStatus = async function(id, newStatus){
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.updateScheduledShow(id, { status: newStatus }, token);
      loadScheduledShows();
    } catch(err){
      alert('Error updating show: ' + (err.message || 'Try again'));
    }
  };

  /* ‚îÄ‚îÄ Delete Show ‚îÄ‚îÄ */
  window.deleteShow = async function(id){
    if(!confirm('Delete this show?')) return;
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.deleteScheduledShow(id, token);
      loadScheduledShows();
    } catch(err){
      alert('Error deleting show: ' + (err.message || 'Try again'));
    }
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COLLECTIONS TAB
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  var allCollections = [];
  var collectionsLoaded = false;
  var collSearchTimer = null;

  var COLL_CATEGORY_LABELS = {
    coins: 'Coins & Bullion',
    pokemon: 'Pokemon',
    sports_cards: 'Sports Cards',
    shoes: 'Shoes'
  };

  window.loadAdminCollections = async function(){
    var search = document.getElementById('collSearchInput').value.trim();
    var category = document.getElementById('collCategoryFilter').value;
    try {
      var token = await snAuth.getAccessToken();
      allCollections = await snProfile.adminListCollections(token, category, search);
      collectionsLoaded = true;
      renderAdminCollections();
      updateCollStats();
    } catch(err){
      console.warn('Load collections error:', err);
      document.getElementById('collTableBody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;padding:40px;color:#ff6b6b">Error loading collections.</td></tr>';
    }
  };

  function renderAdminCollections(){
    var tbody = document.getElementById('collTableBody');
    if(!allCollections.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--silver)">No collection items found.</td></tr>';
      return;
    }

    var html = '';
    allCollections.forEach(function(c){
      var date = c.created_at ? new Date(c.created_at).toLocaleDateString() : '-';
      var cat = c.category || '';
      var user = c.profiles ? ('@' + escapeHtml(c.profiles.username || '')) : '-';
      var details = c.details || {};
      var detailStr = Object.values(details).map(function(v){
        return escapeHtml(String(v).replace(/_/g, ' '));
      }).join(', ');

      // Photo thumbnails
      var photos = c.photo_urls || [];
      var photoHtml = '';
      if(photos.length > 0){
        for(var p = 0; p < photos.length; p++){
          photoHtml += '<img src="' + escapeHtml(photos[p]) + '" style="width:36px;height:36px;border-radius:6px;object-fit:cover;margin-right:4px;border:1px solid rgba(255,255,255,.1)" loading="lazy"/>';
        }
      } else {
        photoHtml = '<span style="color:var(--silver);font-size:11px">No photos</span>';
      }

      html += '<tr>' +
        '<td>' + photoHtml + '</td>' +
        '<td style="max-width:250px">' + escapeHtml(c.description || '-') + '</td>' +
        '<td><span class="profile-badge badge-' + escapeHtml(cat) + '" style="font-size:10px">' + escapeHtml(COLL_CATEGORY_LABELS[cat] || cat) + '</span></td>' +
        '<td style="font-size:12px;color:var(--silver)">' + (detailStr || '-') + '</td>' +
        '<td style="color:var(--blue);font-weight:600">' + user + '</td>' +
        '<td>' + date + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  function updateCollStats(){
    var total = allCollections.length;
    var coins = 0, pokemon = 0, sports = 0;
    allCollections.forEach(function(c){
      if(c.category === 'coins') coins++;
      else if(c.category === 'pokemon') pokemon++;
      else if(c.category === 'sports_cards') sports++;
    });
    document.getElementById('collStatTotal').textContent = total;
    document.getElementById('collStatCoins').textContent = coins;
    document.getElementById('collStatPokemon').textContent = pokemon;
    document.getElementById('collStatSports').textContent = sports;
  }

  window.debounceCollSearch = function(){
    clearTimeout(collSearchTimer);
    collSearchTimer = setTimeout(loadAdminCollections, 400);
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FEED TAB
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  var allFeedEvents = [];
  var feedEventsLoaded = false;

  var FEED_TYPE_LABELS = { wishlist: 'Wishlist', collection: 'Collection', inventory: 'Inventory' };
  var FEED_CAT_LABELS = { coins: 'Coins & Bullion', pokemon: 'Pokemon', sports_cards: 'Sports Cards', shoes: 'Shoes' };

  window.loadAdminFeed = async function(){
    var typeFilter = document.getElementById('feedTypeFilter').value;
    var catFilter = document.getElementById('feedCatFilter').value;
    try {
      var token = await snAuth.getAccessToken();
      // Use the public feed-get endpoint with optional filters
      // We fetch up to 200 events for admin view
      var cursor = null;
      var events = [];
      for(var page = 0; page < 10; page++){
        var headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
        var res = await fetch('https://qsoaransrvpabqpwnjdg.supabase.co/functions/v1/profile-sync', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({ action: 'feed-get', data: { cursor: cursor, category: catFilter || '', event_type: typeFilter || '' } })
        });
        var json = await res.json();
        var batch = json.events || [];
        events = events.concat(batch);
        cursor = json.next_cursor;
        if(!cursor || events.length >= 200) break;
      }
      allFeedEvents = events;
      feedEventsLoaded = true;
      renderAdminFeed();
      updateFeedStats();
    } catch(err){
      console.warn('Load feed error:', err);
      document.getElementById('feedTableBody').innerHTML =
        '<tr><td colspan="8" style="text-align:center;padding:40px;color:#ff6b6b">Error loading feed.</td></tr>';
    }
  };

  function renderAdminFeed(){
    var tbody = document.getElementById('feedTableBody');
    if(!allFeedEvents.length){
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--silver)">No feed events found.</td></tr>';
      return;
    }

    var html = '';
    allFeedEvents.forEach(function(ev){
      var date = ev.created_at ? new Date(ev.created_at).toLocaleDateString() : '-';
      var cat = ev.category || '';
      var typeLabel = FEED_TYPE_LABELS[ev.event_type] || ev.event_type;
      var catLabel = FEED_CAT_LABELS[cat] || cat;

      // Type badge color
      var typeColor = ev.event_type === 'wishlist' ? 'var(--blue)' : ev.event_type === 'collection' ? '#4ade80' : 'var(--gold2)';

      // Reaction total
      var counts = ev.reaction_counts || {};
      var totalReactions = 0;
      for(var k in counts) totalReactions += (counts[k] || 0);

      html += '<tr>' +
        '<td><span style="color:' + typeColor + ';font-weight:700;font-size:11px;text-transform:uppercase">' + escapeHtml(typeLabel) + '</span></td>' +
        '<td style="color:var(--blue);font-weight:600;font-size:12px">@' + escapeHtml(ev.author_username || '-') + '</td>' +
        '<td><span class="profile-badge badge-' + escapeHtml(cat) + '" style="font-size:10px">' + escapeHtml(catLabel) + '</span></td>' +
        '<td style="max-width:200px;font-size:12px">' + escapeHtml((ev.description || '').slice(0, 80)) + '</td>' +
        '<td style="text-align:center;font-size:12px">' + totalReactions + '</td>' +
        '<td style="text-align:center;font-size:12px">' + (ev.comment_count || 0) + '</td>' +
        '<td style="font-size:12px">' + date + '</td>' +
        '<td><button onclick="deleteAdminFeedEvent(\'' + escapeHtml(ev.id) + '\')" style="background:rgba(255,100,100,.1);border:1px solid rgba(255,100,100,.2);color:#ff6b6b;padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">Delete</button></td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  function updateFeedStats(){
    var total = allFeedEvents.length;
    var wishlist = 0, collection = 0, inventory = 0;
    allFeedEvents.forEach(function(ev){
      if(ev.event_type === 'wishlist') wishlist++;
      else if(ev.event_type === 'collection') collection++;
      else if(ev.event_type === 'inventory') inventory++;
    });
    document.getElementById('feedStatTotal').textContent = total;
    document.getElementById('feedStatWishlist').textContent = wishlist;
    document.getElementById('feedStatCollection').textContent = collection;
    document.getElementById('feedStatInventory').textContent = inventory;
  }

  window.deleteAdminFeedEvent = async function(eventId){
    if(!confirm('Delete this feed event? This will also delete its reactions and comments.')) return;
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.adminDeleteFeedEvent(eventId, token);
      loadAdminFeed();
    } catch(err){
      alert('Error deleting feed event: ' + (err.message || 'Try again'));
    }
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INVENTORY MANAGEMENT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  var inventoryLoaded = false;
  var allInventory = [];
  var currentInvTab = 'dashboard';
  var editingInvItem = null; // null = adding, object = editing

  var INV_CATEGORY_LABELS = {
    coins: 'Coins', bullion: 'Bullion',
    pokemon_cards: 'Pokemon Cards', pokemon_sealed: 'Pokemon Sealed',
    sports_cards: 'Sports Cards'
  };
  var INV_STATUS_LABELS = {
    in_stock: 'In Stock', listed: 'Listed', sold: 'Sold',
    returned: 'Returned', held: 'Held'
  };

  // Category detail field definitions
  var INV_DETAIL_FIELDS = {
    coins: [
      {key:'year',label:'Year',type:'text'},{key:'mint_mark',label:'Mint Mark',type:'text'},
      {key:'country',label:'Country',type:'text'},{key:'metal_type',label:'Metal Type',type:'select',opts:['Gold','Silver','Platinum','Palladium','Copper','Other']},
      {key:'denomination',label:'Denomination',type:'text'},{key:'series',label:'Series',type:'text'},
      {key:'condition',label:'Condition',type:'text'},{key:'grade',label:'Grade',type:'text'},
      {key:'grading_company',label:'Grading Company',type:'select',opts:['PCGS','NGC','ANACS','ICG','Raw']},
      {key:'cert_number',label:'Cert Number',type:'text'},{key:'weight_oz',label:'Weight (oz)',type:'number'},
      {key:'purity_pct',label:'Purity %',type:'number'}
    ],
    bullion: [
      {key:'year',label:'Year',type:'text'},{key:'metal_type',label:'Metal Type',type:'select',opts:['Gold','Silver','Platinum','Palladium']},
      {key:'form',label:'Form',type:'select',opts:['Bar','Round','Coin','Shot','Other']},
      {key:'mint_manufacturer',label:'Mint / Manufacturer',type:'text'},{key:'face_value',label:'Face Value',type:'number'},
      {key:'weight_oz_troy',label:'Weight (troy oz)',type:'number'},{key:'purity_pct',label:'Purity %',type:'number'}
    ],
    pokemon_cards: [
      {key:'card_name',label:'Card Name',type:'text'},{key:'set',label:'Set',type:'text'},
      {key:'card_number',label:'Card Number',type:'text'},{key:'rarity',label:'Rarity',type:'select',opts:['Common','Uncommon','Rare','Holo Rare','Ultra Rare','Secret Rare','Illustration Rare','Special Art Rare','Hyper Rare']},
      {key:'condition',label:'Condition',type:'text'},{key:'grade',label:'Grade',type:'text'},
      {key:'grading_company',label:'Grading Company',type:'select',opts:['PSA','BGS','CGC','Raw']},
      {key:'cert_number',label:'Cert Number',type:'text'},
      {key:'holo',label:'Holo?',type:'select',opts:['Yes','No']},
      {key:'first_edition',label:'1st Edition?',type:'select',opts:['Yes','No']},
      {key:'language',label:'Language',type:'select',opts:['English','Japanese','Korean','Chinese','Other']}
    ],
    pokemon_sealed: [
      {key:'set',label:'Set',type:'text'},
      {key:'product_type',label:'Product Type',type:'select',opts:['Booster Box','ETB','Booster Pack','Blister','Collection Box','Tin','Bundle','Other']},
      {key:'language',label:'Language',type:'select',opts:['English','Japanese','Korean','Chinese','Other']},
      {key:'quantity',label:'Quantity',type:'number'}
    ],
    sports_cards: [
      {key:'player_name',label:'Player Name',type:'text'},{key:'team',label:'Team',type:'text'},
      {key:'sport',label:'Sport',type:'select',opts:['Baseball','Basketball','Football','Hockey','Soccer','Other']},
      {key:'card_name',label:'Card Name',type:'text'},{key:'set_year',label:'Set / Year',type:'text'},
      {key:'card_number',label:'Card Number',type:'text'},{key:'parallel',label:'Parallel',type:'text'},
      {key:'condition',label:'Condition',type:'text'},{key:'grade',label:'Grade',type:'text'},
      {key:'grading_company',label:'Grading Company',type:'select',opts:['PSA','BGS','SGC','CGC','Raw']},
      {key:'cert_number',label:'Cert Number',type:'text'},
      {key:'autographed',label:'Autographed?',type:'select',opts:['Yes','No']},
      {key:'numbered',label:'Numbered?',type:'text'},
      {key:'rookie',label:'Rookie?',type:'select',opts:['Yes','No']}
    ]
  };

  /* ‚îÄ‚îÄ Sub-Tab Navigation ‚îÄ‚îÄ */
  window.switchInvTab = function(tab){
    currentInvTab = tab;
    var panels = ['Dashboard','Coins','Bullion','Pokemon','Sports','Wheel','Breaks'];
    panels.forEach(function(p){ document.getElementById('inv'+p).style.display = 'none'; });
    var map = {dashboard:'Dashboard',coins:'Coins',bullion:'Bullion',pokemon:'Pokemon',sports:'Sports',wheel:'Wheel',breaks:'Breaks'};
    if(map[tab]) document.getElementById('inv'+map[tab]).style.display = '';
    document.querySelectorAll('#adminTabInventory > .inv-subtabs .inv-subtab[data-inv-tab]').forEach(function(b){
      b.classList.toggle('active', b.getAttribute('data-inv-tab') === tab);
    });
    // Load category data if needed
    var catMap = {coins:'coins',bullion:'bullion',pokemon:'pokemon_cards',sports:'sports_cards'};
    if(catMap[tab]) renderCategoryTab(catMap[tab], 'inv'+map[tab]);
  };

  /* ‚îÄ‚îÄ Load Dashboard ‚îÄ‚îÄ */
  window.loadInventoryDashboard = async function(){
    try {
      var token = await snAuth.getAccessToken();
      allInventory = await snProfile.adminInventoryList(token, '', '', '');
      inventoryLoaded = true;
      renderDashboard();
      loadSpotPricesDisplay();
    } catch(err){
      console.warn('Inventory load error:', err);
    }
  };

  function loadSpotPricesDisplay(){
    (async function(){
      try {
        var token = await snAuth.getAccessToken();
        var prices = await snProfile.adminRefreshSpotPrices(token);
        if(prices && prices.length){
          prices.forEach(function(sp){
            var metal = sp.metal || sp.name || '';
            var el = document.getElementById('spot' + metal.charAt(0).toUpperCase() + metal.slice(1).toLowerCase());
            var price = parseFloat(sp.price_usd || sp.price_per_oz || 0);
            if(el) el.textContent = price > 0 ? '$' + price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) : 'N/A';
          });
          if(prices[0] && prices[0].updated_at){
            document.getElementById('spotUpdatedAt').textContent = 'Last updated: ' + new Date(prices[0].updated_at).toLocaleString();
          }
        }
      } catch(e){ console.warn('Spot prices display error:', e); }
    })();
  }

  window.refreshSpotPrices = async function(){
    try {
      var token = await snAuth.getAccessToken();
      var result = await snProfile.adminRefreshSpotPrices(token);
      if(result && result.prices){
        result.prices.forEach(function(sp){
          var el = document.getElementById('spot' + sp.metal.charAt(0).toUpperCase() + sp.metal.slice(1));
          if(el) el.textContent = '$' + Number(sp.price_usd).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        });
        document.getElementById('spotUpdatedAt').textContent = 'Updated: ' + new Date().toLocaleString();
      }
      alert('Spot prices refreshed successfully!');
    } catch(err){
      alert('Error refreshing spot prices: ' + (err.message || 'Try again'));
    }
  };

  /* ‚îÄ‚îÄ Dashboard Rendering ‚îÄ‚îÄ */
  function renderDashboard(){
    var total = allInventory.length;
    var inStock = 0, listed = 0, sold = 0;
    var totalCost = 0, totalRevenue = 0, totalFees = 0;
    var catData = {};

    allInventory.forEach(function(item){
      if(item.status === 'in_stock') inStock++;
      else if(item.status === 'listed') listed++;
      else if(item.status === 'sold') sold++;

      var cost = (parseFloat(item.purchase_price) || 0) + (parseFloat(item.buyers_premium) || 0);
      totalCost += cost;

      if(item.status === 'sold'){
        totalRevenue += parseFloat(item.final_sale_price) || 0;
        totalFees += parseFloat(item.sale_fees) || 0;
      }

      var cat = item.category || 'other';
      if(!catData[cat]) catData[cat] = {count:0, inStock:0, sold:0, cost:0, revenue:0, fees:0};
      catData[cat].count++;
      if(item.status === 'in_stock') catData[cat].inStock++;
      if(item.status === 'sold'){
        catData[cat].sold++;
        catData[cat].revenue += parseFloat(item.final_sale_price) || 0;
        catData[cat].fees += parseFloat(item.sale_fees) || 0;
      }
      catData[cat].cost += cost;
    });

    var netProfit = totalRevenue - totalFees - totalCost;
    var margin = totalRevenue > 0 ? ((totalRevenue - totalFees - totalCost) / totalRevenue * 100) : 0;

    document.getElementById('invStatTotal').textContent = total;
    document.getElementById('invStatInStock').textContent = inStock;
    document.getElementById('invStatListed').textContent = listed;
    document.getElementById('invStatSold').textContent = sold;
    document.getElementById('invStatTotalCost').textContent = '$' + totalCost.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById('invStatTotalRevenue').textContent = '$' + totalRevenue.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById('invStatNetProfit').textContent = (netProfit >= 0 ? '' : '-') + '$' + Math.abs(netProfit).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById('invStatNetProfit').style.color = netProfit >= 0 ? '#4ade80' : '#ff6b6b';
    document.getElementById('invStatMargin').textContent = margin.toFixed(1) + '%';
    document.getElementById('invStatMargin').style.color = margin >= 0 ? 'var(--blue)' : '#ff6b6b';

    // Category breakdown table
    var tbody = document.getElementById('invBreakdownBody');
    var cats = Object.keys(catData);
    if(!cats.length){
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--silver)">No inventory items yet.</td></tr>';
      return;
    }
    var html = '';
    cats.forEach(function(cat){
      var d = catData[cat];
      var catProfit = d.revenue - d.fees - d.cost;
      html += '<tr>' +
        '<td><span class="profile-badge" style="font-size:10px;background:rgba(30,144,255,.12);color:var(--blue)">' + escapeHtml(INV_CATEGORY_LABELS[cat] || cat) + '</span></td>' +
        '<td>' + d.count + '</td>' +
        '<td>' + d.inStock + '</td>' +
        '<td>' + d.sold + '</td>' +
        '<td>$' + d.cost.toLocaleString('en-US',{minimumFractionDigits:2}) + '</td>' +
        '<td>$' + d.revenue.toLocaleString('en-US',{minimumFractionDigits:2}) + '</td>' +
        '<td style="color:' + (catProfit >= 0 ? '#4ade80' : '#ff6b6b') + '">' + (catProfit >= 0 ? '' : '-') + '$' + Math.abs(catProfit).toLocaleString('en-US',{minimumFractionDigits:2}) + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  /* ‚îÄ‚îÄ Category Tab Rendering ‚îÄ‚îÄ */
  function renderCategoryTab(category, containerId){
    var container = document.getElementById(containerId);
    var catLabel = INV_CATEGORY_LABELS[category] || category;
    // Map pokemon sub-types for filtering
    var filterCats = category === 'pokemon_cards' ? ['pokemon_cards','pokemon_sealed'] : [category];
    if(containerId === 'invPokemon') filterCats = ['pokemon_cards','pokemon_sealed'];
    var items = allInventory.filter(function(i){ return filterCats.indexOf(i.category) !== -1; });

    var isPriceableCard = (category === 'pokemon_cards' || containerId === 'invPokemon' || category === 'sports_cards');
    var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">' +
      '<h3 style="color:var(--gold2);font-family:\'Bebas Neue\',sans-serif;font-size:22px;letter-spacing:1px;margin:0">' + escapeHtml(catLabel) + ' (' + items.length + ')</h3>' +
      '<div style="display:flex;gap:8px;flex-wrap:wrap">' +
      (isPriceableCard ? '<button class="btn-primary" style="font-size:12px;padding:8px 16px;background:rgba(212,160,23,.15);color:var(--gold2)" onclick="openPriceLookup(\'' + escapeHtml(category) + '\')">&#x1F50D; Price Lookup</button>' : '') +
      '<button class="btn-primary" style="font-size:12px;padding:8px 16px" onclick="openInvAddPanel(\'' + escapeHtml(category) + '\')">+ Add Item</button>' +
      '</div></div>';

    // Search/filter
    html += '<div class="admin-search" style="margin-bottom:16px">' +
      '<input type="text" id="invSearch_' + category + '" placeholder="Search ' + escapeHtml(catLabel.toLowerCase()) + '..." oninput="filterCategoryItems(\'' + category + '\',\'' + containerId + '\')"/>' +
      '<select class="admin-filter" id="invStatusFilter_' + category + '" onchange="filterCategoryItems(\'' + category + '\',\'' + containerId + '\')">' +
      '<option value="">All Status</option>' +
      '<option value="in_stock">In Stock</option><option value="listed">Listed</option>' +
      '<option value="sold">Sold</option><option value="returned">Returned</option><option value="held">Held</option>' +
      '</select></div>';

    // Table
    html += '<div class="admin-table-wrap"><table class="admin-table"><thead><tr>' +
      '<th>Name</th><th>Status</th><th>Purchase</th><th>Market Value</th><th>Sale Price</th><th>P&L</th><th>Actions</th>' +
      '</tr></thead><tbody id="invCatBody_' + category + '">';

    if(!items.length){
      html += '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--silver)">No items yet. Click "+ Add Item" to get started.</td></tr>';
    } else {
      items.forEach(function(item){
        html += buildInvRow(item);
      });
    }
    html += '</tbody></table></div>';
    container.innerHTML = html;

    // Attach row event listeners
    attachInvRowListeners(container);
  }

  function buildInvRow(item){
    var cost = (parseFloat(item.purchase_price) || 0) + (parseFloat(item.buyers_premium) || 0);
    var salePrice = parseFloat(item.final_sale_price) || 0;
    var fees = parseFloat(item.sale_fees) || 0;
    var pl = item.status === 'sold' ? (salePrice - fees - cost) : 0;
    var statusClass = item.status === 'sold' ? 'color:#4ade80' : item.status === 'listed' ? 'color:var(--gold2)' : 'color:var(--blue)';

    return '<tr class="user-row inv-item-row" data-inv-id="' + escapeHtml(item.id) + '">' +
      '<td class="username-cell">' + escapeHtml(item.name) + '</td>' +
      '<td><span style="font-size:11px;font-weight:600;' + statusClass + '">' + escapeHtml(INV_STATUS_LABELS[item.status] || item.status) + '</span></td>' +
      '<td>$' + cost.toLocaleString('en-US',{minimumFractionDigits:2}) + '</td>' +
      '<td>' + (item.market_value ? '$' + parseFloat(item.market_value).toLocaleString('en-US',{minimumFractionDigits:2}) : '-') + '</td>' +
      '<td>' + (salePrice > 0 ? '$' + salePrice.toLocaleString('en-US',{minimumFractionDigits:2}) : '-') + '</td>' +
      '<td style="color:' + (item.status === 'sold' ? (pl >= 0 ? '#4ade80' : '#ff6b6b') : 'var(--silver)') + '">' +
        (item.status === 'sold' ? ((pl >= 0 ? '+' : '-') + '$' + Math.abs(pl).toLocaleString('en-US',{minimumFractionDigits:2})) : '-') + '</td>' +
      '<td>' +
        (item.status !== 'sold' ? '<button class="btn-primary" style="font-size:10px;padding:4px 10px;background:rgba(74,222,128,.15);color:#4ade80;margin-right:4px" onclick="event.stopPropagation();markSold(\'' + escapeHtml(item.id) + '\')">Mark Sold</button>' : '') +
        '<button class="btn-primary" style="font-size:10px;padding:4px 10px;background:rgba(255,107,107,.15);color:#ff6b6b" onclick="event.stopPropagation();deleteInvItem(\'' + escapeHtml(item.id) + '\')">Delete</button>' +
      '</td></tr>';
  }

  function attachInvRowListeners(container){
    container.querySelectorAll('.inv-item-row').forEach(function(row){
      row.addEventListener('click', function(){
        var id = row.getAttribute('data-inv-id');
        var item = allInventory.find(function(i){ return i.id === id; });
        if(item) openInvEditPanel(item);
      });
    });
  }

  window.filterCategoryItems = function(category, containerId){
    var searchEl = document.getElementById('invSearch_' + category);
    var statusEl = document.getElementById('invStatusFilter_' + category);
    var search = searchEl ? searchEl.value.trim().toLowerCase() : '';
    var status = statusEl ? statusEl.value : '';
    var filterCats = containerId === 'invPokemon' ? ['pokemon_cards','pokemon_sealed'] : [category];
    var items = allInventory.filter(function(i){
      if(filterCats.indexOf(i.category) === -1) return false;
      if(status && i.status !== status) return false;
      if(search && (i.name || '').toLowerCase().indexOf(search) === -1) return false;
      return true;
    });
    var tbody = document.getElementById('invCatBody_' + category);
    if(!tbody) return;
    if(!items.length){
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--silver)">No matching items.</td></tr>';
      return;
    }
    var html = '';
    items.forEach(function(item){ html += buildInvRow(item); });
    tbody.innerHTML = html;
    attachInvRowListeners(tbody.closest('.inv-panel') || document.getElementById(containerId));
  };

  /* ‚îÄ‚îÄ Add/Edit Panel ‚îÄ‚îÄ */
  window.openInvAddPanel = function(category){
    editingInvItem = null;
    document.getElementById('invEditTitle').textContent = 'Add Item';
    document.getElementById('invCategory').value = category || 'coins';
    document.getElementById('invStatus').value = 'in_stock';
    document.getElementById('invName').value = '';
    document.getElementById('invPurchaseDate').value = '';
    document.getElementById('invPurchasePrice').value = '';
    document.getElementById('invBuyersPremium').value = '0';
    document.getElementById('invSource').value = '';
    document.getElementById('invMarketValue').value = '';
    document.getElementById('invListedWhatnot').value = 'false';
    document.getElementById('invStreamDate').value = '';
    document.getElementById('invStartingBid').value = '';
    document.getElementById('invFinalSalePrice').value = '';
    document.getElementById('invSaleFees').value = '';
    document.getElementById('invNotes').value = '';
    updateInvDetailFields();
    document.getElementById('invEditOverlay').classList.add('open');
  };

  function openInvEditPanel(item){
    editingInvItem = item;
    document.getElementById('invEditTitle').textContent = 'Edit Item';
    document.getElementById('invCategory').value = item.category || 'coins';
    document.getElementById('invStatus').value = item.status || 'in_stock';
    document.getElementById('invName').value = item.name || '';
    document.getElementById('invPurchaseDate').value = item.purchase_date || '';
    document.getElementById('invPurchasePrice').value = item.purchase_price || '';
    document.getElementById('invBuyersPremium').value = item.buyers_premium || '0';
    document.getElementById('invSource').value = item.source_seller || '';
    document.getElementById('invMarketValue').value = item.market_value || '';
    document.getElementById('invListedWhatnot').value = item.listed_on_whatnot ? 'true' : 'false';
    document.getElementById('invStreamDate').value = item.stream_date || '';
    document.getElementById('invStartingBid').value = item.starting_bid || '';
    document.getElementById('invFinalSalePrice').value = item.final_sale_price || '';
    document.getElementById('invSaleFees').value = item.sale_fees || '';
    document.getElementById('invNotes').value = item.notes || '';
    updateInvDetailFields(item.details || {});
    document.getElementById('invEditOverlay').classList.add('open');
  }

  window.closeInvEditPanel = function(e){
    if(e && e.target !== e.currentTarget) return;
    document.getElementById('invEditOverlay').classList.remove('open');
    editingInvItem = null;
  };

  /* ‚îÄ‚îÄ Dynamic Detail Fields ‚îÄ‚îÄ */
  window.updateInvDetailFields = function(existingDetails){
    var cat = document.getElementById('invCategory').value;
    var fields = INV_DETAIL_FIELDS[cat] || [];
    var container = document.getElementById('invDetailFields');
    var details = existingDetails || {};

    if(!fields.length){
      container.innerHTML = '';
      return;
    }

    var html = '<h4 style="color:var(--blue);font-size:14px;font-weight:600;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px">' + escapeHtml(INV_CATEGORY_LABELS[cat] || cat) + ' Details</h4><div class="inv-form-grid">';
    fields.forEach(function(f){
      html += '<div class="inv-form-field"><label>' + escapeHtml(f.label) + '</label>';
      var val = details[f.key] || '';
      if(f.type === 'select'){
        html += '<select id="invDetail_' + f.key + '">';
        html += '<option value="">--</option>';
        (f.opts || []).forEach(function(opt){
          html += '<option value="' + escapeHtml(opt) + '"' + (val === opt ? ' selected' : '') + '>' + escapeHtml(opt) + '</option>';
        });
        html += '</select>';
      } else if(f.type === 'number'){
        html += '<input type="number" id="invDetail_' + f.key + '" step="any" value="' + escapeHtml(String(val)) + '"/>';
      } else {
        html += '<input type="text" id="invDetail_' + f.key + '" value="' + escapeHtml(String(val)) + '"/>';
      }
      html += '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
  };

  /* ‚îÄ‚îÄ Save / Update Item ‚îÄ‚îÄ */
  window.saveInventoryItem = async function(){
    var name = document.getElementById('invName').value.trim();
    if(!name){ alert('Item name is required.'); return; }
    var cat = document.getElementById('invCategory').value;
    var fields = INV_DETAIL_FIELDS[cat] || [];
    var details = {};
    fields.forEach(function(f){
      var el = document.getElementById('invDetail_' + f.key);
      if(el && el.value) details[f.key] = el.value;
    });

    var payload = {
      name: name,
      category: cat,
      status: document.getElementById('invStatus').value,
      purchase_date: document.getElementById('invPurchaseDate').value || null,
      purchase_price: parseFloat(document.getElementById('invPurchasePrice').value) || null,
      buyers_premium: parseFloat(document.getElementById('invBuyersPremium').value) || 0,
      source_seller: document.getElementById('invSource').value.trim() || null,
      market_value: parseFloat(document.getElementById('invMarketValue').value) || null,
      listed_on_whatnot: document.getElementById('invListedWhatnot').value === 'true',
      stream_date: document.getElementById('invStreamDate').value || null,
      starting_bid: parseFloat(document.getElementById('invStartingBid').value) || null,
      final_sale_price: parseFloat(document.getElementById('invFinalSalePrice').value) || null,
      sale_fees: parseFloat(document.getElementById('invSaleFees').value) || null,
      notes: document.getElementById('invNotes').value.trim() || null,
      details: details
    };

    try {
      var token = await snAuth.getAccessToken();
      if(editingInvItem){
        await snProfile.adminInventoryUpdate(editingInvItem.id, payload, token);
      } else {
        await snProfile.adminInventoryAdd(payload, token);
      }
      closeInvEditPanel();
      // Reload
      allInventory = await snProfile.adminInventoryList(token, '', '', '');
      renderDashboard();
      // Re-render current category tab if applicable
      var catMap = {coins:'coins',bullion:'bullion',pokemon:'pokemon_cards',sports:'sports_cards'};
      if(catMap[currentInvTab]) renderCategoryTab(catMap[currentInvTab], 'inv' + currentInvTab.charAt(0).toUpperCase() + currentInvTab.slice(1));
    } catch(err){
      alert('Error saving item: ' + (err.message || 'Try again'));
    }
  };

  /* ‚îÄ‚îÄ Mark Sold ‚îÄ‚îÄ */
  window.markSold = async function(itemId){
    var price = prompt('Enter final sale price ($):');
    if(price === null) return;
    var fees = prompt('Enter sale fees ($):') || '0';
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.adminInventoryMarkSold(itemId, parseFloat(price), parseFloat(fees), token);
      allInventory = await snProfile.adminInventoryList(token, '', '', '');
      renderDashboard();
      var catMap = {coins:'coins',bullion:'bullion',pokemon:'pokemon_cards',sports:'sports_cards'};
      if(catMap[currentInvTab]) renderCategoryTab(catMap[currentInvTab], 'inv' + currentInvTab.charAt(0).toUpperCase() + currentInvTab.slice(1));
    } catch(err){
      alert('Error marking as sold: ' + (err.message || 'Try again'));
    }
  };

  /* ‚îÄ‚îÄ Delete Item ‚îÄ‚îÄ */
  window.deleteInvItem = async function(itemId){
    if(!confirm('Delete this inventory item? This cannot be undone.')) return;
    try {
      var token = await snAuth.getAccessToken();
      await snProfile.adminInventoryRemove(itemId, token);
      allInventory = await snProfile.adminInventoryList(token, '', '', '');
      renderDashboard();
      var catMap = {coins:'coins',bullion:'bullion',pokemon:'pokemon_cards',sports:'sports_cards'};
      if(catMap[currentInvTab]) renderCategoryTab(catMap[currentInvTab], 'inv' + currentInvTab.charAt(0).toUpperCase() + currentInvTab.slice(1));
    } catch(err){
      alert('Error deleting item: ' + (err.message || 'Try again'));
    }
  };

  /* ‚îÄ‚îÄ JustTCG Price Lookup ‚îÄ‚îÄ */
  window.openPriceLookup = function(category){
    var game = (category === 'sports_cards') ? '' : 'pokemon';
    var query = prompt('Search JustTCG for card prices:\n\nEnter card name (e.g. "Charizard ex"):');
    if(!query) return;
    searchJustTCG(query, game);
  };

  async function searchJustTCG(query, game){
    try {
      var token = await snAuth.getAccessToken();
      var result = await snProfile.justtcgSearch(query, game, {include_price_history: true, priceHistoryDuration: '30d'}, token);
      var cards = result.cards || [];
      if(!cards.length){
        alert('No results found for "' + query + '"');
        return;
      }
      showPriceLookupResults(cards, result.meta);
    } catch(err){
      alert('Price lookup error: ' + (err.message || 'Try again'));
    }
  }

  function showPriceLookupResults(cards, meta){
    var overlay = document.getElementById('priceLookupOverlay');
    var body = document.getElementById('priceLookupBody');
    var html = '';
    cards.forEach(function(card){
      var variants = card.variants || [];
      var mainVariant = variants[0] || {};
      var price = mainVariant.price ? '$' + Number(mainVariant.price).toFixed(2) : 'N/A';
      var change7d = mainVariant.priceChange7d ? (mainVariant.priceChange7d > 0 ? '+' : '') + Number(mainVariant.priceChange7d).toFixed(2) + '%' : '';
      var change30d = mainVariant.priceChange30d ? (mainVariant.priceChange30d > 0 ? '+' : '') + Number(mainVariant.priceChange30d).toFixed(2) + '%' : '';
      var color7d = mainVariant.priceChange7d > 0 ? '#4ade80' : mainVariant.priceChange7d < 0 ? '#ff6b6b' : 'var(--silver)';
      var color30d = mainVariant.priceChange30d > 0 ? '#4ade80' : mainVariant.priceChange30d < 0 ? '#ff6b6b' : 'var(--silver)';

      html += '<tr>' +
        '<td class="username-cell">' + escapeHtml(card.name || '') + '</td>' +
        '<td>' + escapeHtml(card.set_name || card.set || '') + '</td>' +
        '<td>' + escapeHtml(card.number || '') + '</td>' +
        '<td style="color:var(--gold2);font-weight:600">' + price + '</td>' +
        '<td style="color:' + color7d + '">' + change7d + '</td>' +
        '<td style="color:' + color30d + '">' + change30d + '</td>' +
        '<td>' + escapeHtml(mainVariant.condition || '') + ' ' + escapeHtml(mainVariant.printing || '') + '</td>' +
        '</tr>';
      // Show additional variants
      if(variants.length > 1){
        variants.slice(1).forEach(function(v){
          var vPrice = v.price ? '$' + Number(v.price).toFixed(2) : 'N/A';
          html += '<tr style="opacity:.7">' +
            '<td style="padding-left:32px;color:var(--silver);font-size:12px">&#x2514; ' + escapeHtml(card.name || '') + '</td>' +
            '<td style="font-size:12px">' + escapeHtml(card.set_name || card.set || '') + '</td>' +
            '<td style="font-size:12px">' + escapeHtml(card.number || '') + '</td>' +
            '<td style="color:var(--gold2);font-size:12px">' + vPrice + '</td>' +
            '<td></td><td></td>' +
            '<td style="font-size:12px">' + escapeHtml(v.condition || '') + ' ' + escapeHtml(v.printing || '') + '</td>' +
            '</tr>';
        });
      }
    });
    body.innerHTML = html;
    if(meta && meta.requestsRemaining !== undefined){
      document.getElementById('priceLookupMeta').textContent = 'API calls remaining today: ' + meta.requestsRemaining;
    }
    overlay.classList.add('open');
  }

  window.closePriceLookup = function(e){
    if(e && e.target !== e.currentTarget) return;
    document.getElementById('priceLookupOverlay').classList.remove('open');
  };

  window.searchJustTCGFromPanel = function(){
    var input = document.getElementById('priceLookupInput');
    var query = input ? input.value.trim() : '';
    if(!query){ alert('Enter a card name to search.'); return; }
    var game = (currentInvTab === 'sports') ? '' : 'pokemon';
    document.getElementById('priceLookupBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--silver)">Searching...</td></tr>';
    searchJustTCG(query, game);
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     WHEEL BUILDER CALCULATOR
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  var wheelPrizes = []; // [{name, value, slots}]

  window.wheelAddPrize = function(){
    wheelPrizes.push({name:'Prize ' + (wheelPrizes.length + 1), value:0, slots:1});
    wheelRender();
    wheelRecalc();
  };

  window.wheelRemovePrize = function(idx){
    wheelPrizes.splice(idx, 1);
    wheelRender();
    wheelRecalc();
  };

  function wheelRender(){
    var tbody = document.getElementById('wheelPrizeBody');
    if(!wheelPrizes.length){
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--silver)">No prizes added yet. Click "+ Add Prize" to begin.</td></tr>';
      return;
    }
    var totalSlots = wheelPrizes.reduce(function(s,p){ return s + (parseInt(p.slots)||0); }, 0);
    var html = '';
    wheelPrizes.forEach(function(p, idx){
      var prob = totalSlots > 0 ? ((parseInt(p.slots)||0) / totalSlots * 100) : 0;
      var ev = totalSlots > 0 ? ((parseInt(p.slots)||0) / totalSlots * (parseFloat(p.value)||0)) : 0;
      html += '<tr>' +
        '<td><input type="text" value="' + escapeHtml(p.name) + '" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px 10px;color:var(--white);font-size:13px;width:100%" onchange="wheelPrizes['+idx+'].name=this.value"/></td>' +
        '<td><input type="number" value="' + (p.value||0) + '" min="0" step="0.01" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px 10px;color:var(--white);font-size:13px;width:80px" onchange="wheelPrizes['+idx+'].value=parseFloat(this.value)||0;wheelRecalc()"/></td>' +
        '<td><input type="number" value="' + (p.slots||1) + '" min="1" step="1" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px 10px;color:var(--white);font-size:13px;width:60px" onchange="wheelPrizes['+idx+'].slots=parseInt(this.value)||1;wheelRecalc()"/></td>' +
        '<td style="color:var(--blue)">' + prob.toFixed(1) + '%</td>' +
        '<td style="color:var(--gold2)">$' + ev.toFixed(2) + '</td>' +
        '<td><button class="btn-primary" style="font-size:10px;padding:4px 8px;background:rgba(255,107,107,.15);color:#ff6b6b" onclick="wheelRemovePrize('+idx+')">X</button></td></tr>';
    });
    tbody.innerHTML = html;
  }

  window.wheelRecalc = function(){
    var spinPrice = parseFloat(document.getElementById('wheelSpinPrice').value) || 0;
    var totalSlots = wheelPrizes.reduce(function(s,p){ return s + (parseInt(p.slots)||0); }, 0);
    var totalCost = wheelPrizes.reduce(function(s,p){ return s + ((parseInt(p.slots)||0) * (parseFloat(p.value)||0)); }, 0);
    var ev = totalSlots > 0 ? wheelPrizes.reduce(function(s,p){ return s + ((parseInt(p.slots)||0) / totalSlots * (parseFloat(p.value)||0)); }, 0) : 0;

    document.getElementById('wheelTotalSlots').textContent = totalSlots;
    document.getElementById('wheelTotalCost').textContent = '$' + totalCost.toFixed(2);

    var revPerCycle = spinPrice * totalSlots;
    var profitPerCycle = revPerCycle - totalCost;
    var margin = revPerCycle > 0 ? (profitPerCycle / revPerCycle * 100) : 0;
    var houseEdge = spinPrice > 0 ? ((spinPrice - ev) / spinPrice * 100) : 0;
    var breakEven = totalSlots > 0 ? (totalCost / totalSlots) : 0;

    document.getElementById('wheelRevPerCycle').textContent = '$' + revPerCycle.toFixed(2);
    document.getElementById('wheelCostPerCycle').textContent = '$' + totalCost.toFixed(2);
    document.getElementById('wheelProfitPerCycle').textContent = (profitPerCycle >= 0 ? '' : '-') + '$' + Math.abs(profitPerCycle).toFixed(2);
    document.getElementById('wheelProfitPerCycle').style.color = profitPerCycle >= 0 ? '#4ade80' : '#ff6b6b';
    document.getElementById('wheelMargin').textContent = margin.toFixed(1) + '%';
    document.getElementById('wheelMargin').style.color = margin >= 0 ? '#c084fc' : '#ff6b6b';
    document.getElementById('wheelEV').textContent = '$' + ev.toFixed(2);
    document.getElementById('wheelHouseEdge').textContent = houseEdge.toFixed(1) + '%';
    document.getElementById('wheelBreakEven').textContent = '$' + breakEven.toFixed(2);

    // Re-render probability table
    wheelRender();
  };

  window.wheelSaveConfig = function(){
    var name = prompt('Config name:');
    if(!name) return;
    var configs = JSON.parse(localStorage.getItem('sn_wheel_configs') || '{}');
    configs[name] = {
      spinPrice: parseFloat(document.getElementById('wheelSpinPrice').value) || 0,
      prizes: JSON.parse(JSON.stringify(wheelPrizes))
    };
    localStorage.setItem('sn_wheel_configs', JSON.stringify(configs));
    alert('Config "' + name + '" saved!');
  };

  window.wheelLoadConfig = function(){
    var configs = JSON.parse(localStorage.getItem('sn_wheel_configs') || '{}');
    var names = Object.keys(configs);
    if(!names.length){ alert('No saved configs.'); return; }
    var name = prompt('Available configs:\\n' + names.join('\\n') + '\\n\\nEnter name to load:');
    if(!name || !configs[name]) return;
    wheelPrizes = configs[name].prizes || [];
    document.getElementById('wheelSpinPrice').value = configs[name].spinPrice || 10;
    wheelRender();
    wheelRecalc();
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BREAK CALCULATORS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  /* ‚îÄ‚îÄ Break Sub-Tab Nav ‚îÄ‚îÄ */
  window.switchBreakTab = function(tab){
    document.getElementById('breakRandom').style.display = tab === 'random' ? '' : 'none';
    document.getElementById('breakPickTeam').style.display = tab === 'pickteam' ? '' : 'none';
    document.querySelectorAll('#invBreaks .inv-subtab').forEach(function(b){
      b.classList.toggle('active', b.getAttribute('data-break-tab') === tab);
    });
  };

  /* ‚îÄ‚îÄ Random Pack Break ‚îÄ‚îÄ */
  window.calcRandomBreak = function(){
    var boxCost = parseFloat(document.getElementById('breakBoxCost').value) || 0;
    var slots = parseInt(document.getElementById('breakSlots').value) || 1;
    var preset = document.getElementById('breakMarginPreset').value;

    document.getElementById('breakCustomMarginWrap').style.display = preset === 'custom' ? '' : 'none';
    var marginPct = preset === 'custom' ? (parseFloat(document.getElementById('breakCustomMargin').value) || 0) : parseFloat(preset);

    var costPerSlot = boxCost / slots;
    var pricePerSlot = costPerSlot * (1 + marginPct / 100);
    var totalRevenue = pricePerSlot * slots;
    var totalProfit = totalRevenue - boxCost;

    document.getElementById('breakCostPerSlot').textContent = '$' + costPerSlot.toFixed(2);
    document.getElementById('breakPricePerSlot').textContent = '$' + pricePerSlot.toFixed(2);
    document.getElementById('breakTotalRevenue').textContent = '$' + totalRevenue.toFixed(2);
    document.getElementById('breakTotalProfit').textContent = (totalProfit >= 0 ? '' : '-') + '$' + Math.abs(totalProfit).toFixed(2);
    document.getElementById('breakTotalProfit').style.color = totalProfit >= 0 ? '#c084fc' : '#ff6b6b';
  };

  /* ‚îÄ‚îÄ Pick Your Team Break ‚îÄ‚îÄ */
  var pytTeams = []; // [{name, weight, override}]

  window.pytAddTeam = function(){
    pytTeams.push({name:'Team ' + (pytTeams.length + 1), weight:1, override:''});
    pytRender();
    calcPYTBreak();
  };

  window.pytRemoveTeam = function(idx){
    pytTeams.splice(idx, 1);
    pytRender();
    calcPYTBreak();
  };

  function pytRender(){
    var tbody = document.getElementById('pytTeamBody');
    if(!pytTeams.length){
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--silver)">No teams added yet. Click "+ Add Team" to begin.</td></tr>';
      return;
    }
    var boxCost = parseFloat(document.getElementById('pytBoxCost').value) || 0;
    var marginPct = parseFloat(document.getElementById('pytMargin').value) || 0;
    var totalWeight = pytTeams.reduce(function(s,t){ return s + (parseFloat(t.weight)||0); }, 0);
    var targetRevenue = boxCost * (1 + marginPct / 100);

    var html = '';
    pytTeams.forEach(function(t, idx){
      var autoPrice = totalWeight > 0 ? ((parseFloat(t.weight)||0) / totalWeight * targetRevenue) : 0;
      html += '<tr>' +
        '<td><input type="text" value="' + escapeHtml(t.name) + '" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px 10px;color:var(--white);font-size:13px;width:100%" onchange="pytTeams['+idx+'].name=this.value"/></td>' +
        '<td><input type="number" value="' + (t.weight||1) + '" min="0.1" step="0.1" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px 10px;color:var(--white);font-size:13px;width:60px" onchange="pytTeams['+idx+'].weight=parseFloat(this.value)||1;calcPYTBreak()"/></td>' +
        '<td style="color:var(--blue)">$' + autoPrice.toFixed(2) + '</td>' +
        '<td><input type="number" value="' + (t.override||'') + '" min="0" step="0.01" placeholder="Auto" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px 10px;color:var(--white);font-size:13px;width:80px" onchange="pytTeams['+idx+'].override=this.value;calcPYTBreak()"/></td>' +
        '<td><button class="btn-primary" style="font-size:10px;padding:4px 8px;background:rgba(255,107,107,.15);color:#ff6b6b" onclick="pytRemoveTeam('+idx+')">X</button></td></tr>';
    });
    tbody.innerHTML = html;
  }

  window.calcPYTBreak = function(){
    var boxCost = parseFloat(document.getElementById('pytBoxCost').value) || 0;
    var marginPct = parseFloat(document.getElementById('pytMargin').value) || 0;
    var totalWeight = pytTeams.reduce(function(s,t){ return s + (parseFloat(t.weight)||0); }, 0);
    var targetRevenue = boxCost * (1 + marginPct / 100);

    var actualRevenue = 0;
    pytTeams.forEach(function(t){
      if(t.override && parseFloat(t.override) > 0){
        actualRevenue += parseFloat(t.override);
      } else {
        var autoPrice = totalWeight > 0 ? ((parseFloat(t.weight)||0) / totalWeight * targetRevenue) : 0;
        actualRevenue += autoPrice;
      }
    });
    var actualProfit = actualRevenue - boxCost;

    document.getElementById('pytTotalWeight').textContent = totalWeight.toFixed(1);
    document.getElementById('pytTargetRevenue').textContent = '$' + targetRevenue.toFixed(2);
    document.getElementById('pytActualRevenue').textContent = '$' + actualRevenue.toFixed(2);
    document.getElementById('pytActualProfit').textContent = (actualProfit >= 0 ? '' : '-') + '$' + Math.abs(actualProfit).toFixed(2);
    document.getElementById('pytActualProfit').style.color = actualProfit >= 0 ? '#c084fc' : '#ff6b6b';

    pytRender();
  };

  // Initialize break calculator on load
  calcRandomBreak();

  /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
  function escapeHtml(str){
    return snSanitize.html(str);
  }

  /* ‚îÄ‚îÄ Listen for auth ready event ‚îÄ‚îÄ */
  window.addEventListener('snauth:ready', function(e){
    if(e.detail && e.detail.profile && (e.detail.profile.role === 'admin' || e.detail.profile.role === 'host')){
      showSection('adminContent');
      if(e.detail.profile.role === 'host'){
        document.getElementById('tabUsers').style.display = 'none';
        document.getElementById('tabWishes').style.display = 'none';
        document.getElementById('tabSchedule').style.display = 'none';
        document.getElementById('tabCollections').style.display = 'none';
        document.getElementById('tabFeed').style.display = 'none';
        switchAdminTab('inventory');
      } else {
        loadHostsList();
        loadUsers();
      }
    }
  });

  // Boot
  initAdminPage();
})();
</script>
</body>
</html>
