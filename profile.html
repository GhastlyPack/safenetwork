<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>My Profile | Safe Network</title>
<link rel="icon" href="https://res.cloudinary.com/dqn1tnmhl/image/upload/v1771979447/SN_ico_remukb.png"/>
<meta name="description" content="Manage your Safe Network profile, collecting interests, and privacy settings."/>
<link rel="stylesheet" href="/css/global.css">
<link rel="stylesheet" href="/css/auth.css">
<link rel="stylesheet" href="/css/profile.css">
<link rel="stylesheet" href="/css/collection.css">
<link rel="stylesheet" href="/css/feed.css">
<link rel="stylesheet" href="/css/cookies.css">
<script src="/js/sanitize.js"></script>
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">
    <img src="https://images.whatnot.com/fit-in/3840x0/filters:format(webp)/users%2F52444196%2Fb252b0ef-b6ce-4c9f-ba86-18ffd423776f.png" alt="Safe Network"/>
    <span>SAFE NETWORK</span>
  </a>
  <ul class="nav-links">
    <li><a href="/#shows">Shows</a></li>
    <li><a href="/#host">Hosts</a></li>
    <li><a href="https://www.whatnot.com/user/safenetwork" target="_blank">Watch Live</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/schedule.html">Schedule</a></li>
    <li class="nav-secondary"><a href="/#socials">Links</a></li>
  </ul>
  <button id="authLoginBtn" class="auth-login-btn" onclick="window.snAuth && snAuth.login()">Log In</button>
  <div id="authProfileWrap" class="auth-profile-wrap">
    <div class="auth-avatar" onclick="snAuth.toggleProfileDropdown()">
      <img id="authAvatarImg" alt="Profile"/>
      <span id="authAvatarInitials" class="auth-avatar-initials"></span>
    </div>
    <div id="authDropdown" class="auth-dropdown">
      <div class="auth-dropdown-label">Signed in as</div>
      <div id="authDropdownEmail" class="auth-dropdown-email"></div>
      <button class="auth-logout-btn" onclick="snAuth.logout()">Log Out</button>
    </div>
  </div>
  <button class="hamburger" onclick="toggleMenu()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
</nav>

<ul class="mobile-menu" id="mobileMenu">
  <li><a href="/#shows">Shows</a></li>
  <li><a href="/#host">Hosts</a></li>
  <li><a href="https://www.whatnot.com/user/safenetwork" target="_blank">Watch Live</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/schedule.html">Schedule</a></li>
  <li><a href="/#socials">Links</a></li>
  <li id="authMobileLogin" class="auth-mobile-login"><a href="#" onclick="event.preventDefault();window.snAuth && snAuth.login()">Log In</a></li>
  <li id="authMobileProfile" class="auth-mobile-profile">
    <div class="auth-mobile-signed-in">Signed in as <span id="authMobileEmail" class="auth-mobile-email"></span></div>
    <button class="auth-mobile-logout" onclick="snAuth.logout()">Log Out</button>
  </li>
</ul>

<!-- Loading State (shown while checking auth) -->
<div class="profile-wrap" id="profileLoading">
  <div class="profile-loading">
    <p>Loading your profile...</p>
  </div>
</div>

<!-- Login Prompt (shown when logged out) -->
<div class="profile-wrap" id="profileLoginPrompt" style="display:none">
  <div class="profile-login-prompt">
    <h1>My Profile</h1>
    <p>Log in to view and manage your Safe Network profile, collecting interests, and privacy settings.</p>
    <button class="btn-primary" onclick="window.snAuth && snAuth.login()">Log In to Continue</button>
  </div>
</div>

<!-- Profile Content (shown when logged in) -->
<div class="profile-wrap" id="profileContent" style="display:none">
  <h1>My Profile</h1>

  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-avatar" id="profileAvatar" onclick="document.getElementById('avatarFileInput').click()" title="Change profile picture">
      <img id="profileAvatarImg" alt="Avatar"/>
      <span class="profile-avatar-initials" id="profileAvatarInitials"></span>
      <span class="profile-avatar-overlay">Edit</span>
    </div>
    <input type="file" id="avatarFileInput" accept="image/jpeg,image/png,image/webp" style="display:none"/>
    <div class="profile-header-info">
      <h2 id="profileDisplayName">Loading...</h2>
      <div class="profile-username" id="profileUsernameDisplay">@...</div>
      <div class="profile-badges" id="profileBadges"></div>
      <div class="follow-counts" id="profileFollowCounts" style="display:none;justify-content:flex-start;margin:6px 0 0">
        <span><strong id="profileFollowerCount">0</strong> Followers</span>
        <span><strong id="profileFollowingCount">0</strong> Following</span>
      </div>
    </div>
  </div>

  <!-- View Public Profile Link -->
  <a href="#" id="viewPublicProfile" class="view-public-link" style="display:none">View my public profile &rarr;</a>

  <!-- Loyalty Section -->
  <div class="profile-loyalty">
    <h3>Loyalty Status</h3>
    <div class="loyalty-tier-display">
      <span class="loyalty-tier-name" id="loyaltyTierName">Bronze</span>
      <span class="loyalty-points" id="loyaltyPoints">0 points</span>
    </div>
    <div class="loyalty-progress">
      <div class="loyalty-bar" id="loyaltyBar" style="width:0%"></div>
    </div>
    <div class="loyalty-hint" id="loyaltyHint">Earn points by shopping on our Whatnot shows</div>
  </div>

  <!-- Edit Form -->
  <form id="profileForm" onsubmit="saveProfile(event)">

    <!-- Display Name -->
    <div class="profile-field">
      <label for="profileName">Display Name</label>
      <input type="text" id="profileName" name="display_name" placeholder="Your display name" maxlength="50"/>
    </div>

    <!-- Username -->
    <div class="profile-field">
      <label>Username</label>
      <div class="username-input-wrap">
        <span class="username-prefix">@</span>
        <input type="text" id="profileUsername" name="username" placeholder="your_username" maxlength="30"/>
        <span class="username-status" id="usernameStatus"></span>
      </div>
      <div class="field-hint">Letters, numbers, underscores only. This is how other collectors will find you.</div>
    </div>

    <!-- Whatnot Username -->
    <div class="profile-field">
      <label for="profileWhatnot">Whatnot Username</label>
      <input type="text" id="profileWhatnot" name="whatnot_username" placeholder="Your Whatnot handle (optional)" maxlength="50"/>
      <div class="field-hint">Link your Whatnot account so hosts can recognize you during shows.</div>
    </div>

    <!-- Bio -->
    <div class="profile-field">
      <label for="profileBio">Bio</label>
      <textarea id="profileBio" name="bio" placeholder="Tell us about your collection..." maxlength="300" rows="3"></textarea>
      <div class="field-hint"><span id="bioCharCount">0</span>/300 characters</div>
    </div>

    <!-- Collecting Interests -->
    <div class="profile-field">
      <label>Collecting Interests</label>
      <fieldset class="interest-grid">
        <legend>Interests</legend>
        <label><input type="checkbox" name="interests" value="coins"/> Coins &amp; Bullion</label>
        <label><input type="checkbox" name="interests" value="pokemon"/> Pokemon</label>
        <label><input type="checkbox" name="interests" value="sports_cards"/> Sports Cards</label>
        <label><input type="checkbox" name="interests" value="shoes"/> Shoes</label>
      </fieldset>
    </div>

    <!-- Privacy Settings -->
    <div class="profile-field">
      <label>Privacy Settings</label>
      <label class="toggle-label">
        <input type="checkbox" id="profilePublic" name="profile_public" checked/>
        <span>Make my profile public (other collectors can view your profile)</span>
      </label>
    </div>
    <div class="profile-field">
      <label class="toggle-label">
        <input type="checkbox" id="profileEmailVisible" name="email_visible"/>
        <span>Show my email on my public profile</span>
      </label>
    </div>

    <!-- Status Message -->
    <div class="profile-status" id="profileStatus"></div>

    <!-- Save Button -->
    <button type="submit" class="profile-save-btn" id="profileSaveBtn">Save Changes</button>
  </form>

  <!-- Collection Preview -->
  <div class="collection-preview-section" id="collectionPreview">
    <div class="collection-preview-header">
      <h3>My Collection</h3>
      <a href="/collection.html" class="collection-preview-link">View Full Collection &rarr;</a>
    </div>
    <div id="collectionPreviewGrid"></div>
  </div>
</div>

<!-- Avatar Crop Modal -->
<div id="avatarCropModal" style="display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center">
  <div style="background:linear-gradient(135deg,#0f1628,#0a0e1a);border:1px solid rgba(30,144,255,.2);border-radius:16px;padding:28px;max-width:360px;width:90%;text-align:center">
    <h3 style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;margin-bottom:16px">Crop Profile Picture</h3>
    <div id="cropArea" style="position:relative;width:240px;height:240px;margin:0 auto 16px;border-radius:50%;overflow:hidden;border:3px solid rgba(30,144,255,.3);background:#111;cursor:grab;touch-action:none">
      <img id="cropImg" style="position:absolute;max-width:none;pointer-events:none;user-select:none" draggable="false"/>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;padding:0 12px">
      <span style="color:var(--silver);font-size:12px">-</span>
      <input type="range" id="cropZoom" min="100" max="300" value="100" style="flex:1;accent-color:var(--blue)"/>
      <span style="color:var(--silver);font-size:12px">+</span>
    </div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button onclick="cancelCrop()" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--silver);padding:10px 24px;border-radius:8px;font-weight:600;font-size:13px;font-family:'Inter',sans-serif;cursor:pointer">Cancel</button>
      <button onclick="confirmCrop()" style="background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;border:none;padding:10px 24px;border-radius:8px;font-weight:700;font-size:13px;font-family:'Inter',sans-serif;cursor:pointer;box-shadow:0 0 12px rgba(30,144,255,.3)">Save</button>
    </div>
  </div>
</div>

<footer>
  <div class="footer-logo">SAFE NETWORK</div>
  <div><a href="/privacy.html">Privacy Policy</a> · <a href="/terms.html">Terms of Service</a></div>
  <p>2026 Safe Network · safenetwork.shop</p>
</footer>

<script>
  function toggleMenu(){
    document.getElementById('mobileMenu').classList.toggle('open');
    document.querySelector('.hamburger').classList.toggle('open');
  }
</script>
<script src="/js/supabase.js"></script>
<script src="/js/cookies.js"></script>
<script src="/js/auth.js"></script>
<script>
/* ── Profile Page Logic ── */
(function(){
  var currentProfile = null;
  var originalUsername = '';
  var usernameTimer = null;
  var usernameAvailable = true;

  /* Wait for auth to be ready, then load profile */
  async function initProfilePage(){
    // Give auth.js a moment to initialize
    var maxWait = 50; // 5 seconds max
    while(!window.snAuth && maxWait > 0){
      await new Promise(function(r){ setTimeout(r, 100); });
      maxWait--;
    }

    if(!window.snAuth){
      showSection('profileLoginPrompt');
      return;
    }

    var loggedIn = await snAuth.isLoggedIn();
    if(!loggedIn){
      showSection('profileLoginPrompt');
      return;
    }

    // User is logged in - try to load profile
    var cached = window.snProfile ? snProfile.getCachedProfile() : null;
    if(cached){
      currentProfile = cached;
      renderProfile();
      showSection('profileContent');
      loadCollectionPreview();
    } else {
      // Try to init/fetch profile
      try {
        var user = await snAuth.getUser();
        var token = await snAuth.getAccessToken();
        if(user && token && window.snProfile){
          currentProfile = await snProfile.initProfile(user, token);
          if(currentProfile){
            renderProfile();
            showSection('profileContent');
            loadCollectionPreview();
          } else {
            showSection('profileLoginPrompt');
          }
        } else {
          showSection('profileLoginPrompt');
        }
      } catch(err){
        console.warn('Profile load error:', err);
        showSection('profileLoginPrompt');
      }
    }
  }

  function showSection(id){
    document.getElementById('profileLoading').style.display = 'none';
    document.getElementById('profileLoginPrompt').style.display = 'none';
    document.getElementById('profileContent').style.display = 'none';
    document.getElementById(id).style.display = '';
  }

  /* ── Render Profile Data into Form ── */
  function renderProfile(){
    if(!currentProfile) return;
    var p = currentProfile;

    // Header
    var avatarImg = document.getElementById('profileAvatarImg');
    var avatarInitials = document.getElementById('profileAvatarInitials');
    var initial = (p.display_name || p.email || '?').charAt(0).toUpperCase();
    if(p.avatar_url){
      avatarImg.src = p.avatar_url;
      avatarImg.style.display = 'block';
      avatarInitials.style.display = 'none';
      avatarImg.onerror = function(){
        avatarImg.style.display = 'none';
        avatarInitials.style.display = 'flex';
        avatarInitials.textContent = initial;
      };
    } else {
      avatarImg.style.display = 'none';
      avatarInitials.style.display = 'flex';
      avatarInitials.textContent = initial;
    }

    document.getElementById('profileDisplayName').textContent = p.display_name || p.username || 'Collector';
    document.getElementById('profileUsernameDisplay').textContent = '@' + (p.username || '');

    // Badges
    var badgesEl = document.getElementById('profileBadges');
    badgesEl.innerHTML = '';
    // Role badge
    var roleBadge = document.createElement('span');
    roleBadge.className = 'profile-badge badge-' + (p.role || 'shopper');
    roleBadge.textContent = (p.role || 'shopper').charAt(0).toUpperCase() + (p.role || 'shopper').slice(1);
    badgesEl.appendChild(roleBadge);
    // Tier badge
    var tierBadge = document.createElement('span');
    tierBadge.className = 'profile-badge badge-' + (p.loyalty_tier || 'bronze');
    tierBadge.textContent = (p.loyalty_tier || 'bronze').charAt(0).toUpperCase() + (p.loyalty_tier || 'bronze').slice(1);
    badgesEl.appendChild(tierBadge);

    // Loyalty
    var points = p.loyalty_points || 0;
    var tier = p.loyalty_tier || 'bronze';
    document.getElementById('loyaltyTierName').textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
    document.getElementById('loyaltyPoints').textContent = points + ' points';

    // Progress bar (tier thresholds: bronze 0, silver 500, gold 2000, diamond 10000)
    var thresholds = { bronze: { min: 0, max: 500 }, silver: { min: 500, max: 2000 }, gold: { min: 2000, max: 10000 }, diamond: { min: 10000, max: 10000 } };
    var t = thresholds[tier] || thresholds.bronze;
    var progress = tier === 'diamond' ? 100 : Math.min(100, Math.round(((points - t.min) / (t.max - t.min)) * 100));
    document.getElementById('loyaltyBar').style.width = progress + '%';

    var nextTier = { bronze: 'Silver', silver: 'Gold', gold: 'Diamond', diamond: null };
    var next = nextTier[tier];
    document.getElementById('loyaltyHint').textContent = next
      ? (t.max - points) + ' more points to reach ' + next + ' tier'
      : 'You\'ve reached the highest tier!';

    // Follower/following counts
    var followCountsEl = document.getElementById('profileFollowCounts');
    if(followCountsEl){
      document.getElementById('profileFollowerCount').textContent = p.follower_count || 0;
      document.getElementById('profileFollowingCount').textContent = p.following_count || 0;
      followCountsEl.style.display = '';
    }

    // View public profile link
    var pubLink = document.getElementById('viewPublicProfile');
    if(pubLink && p.username){
      pubLink.href = '/collector.html?u=' + encodeURIComponent(p.username);
      pubLink.style.display = '';
    }

    // Form fields
    document.getElementById('profileName').value = p.display_name || '';
    document.getElementById('profileUsername').value = p.username || '';
    originalUsername = p.username || '';
    document.getElementById('profileWhatnot').value = p.whatnot_username || '';
    document.getElementById('profileBio').value = p.bio || '';
    updateBioCount();
    document.getElementById('profilePublic').checked = p.profile_public !== false;
    document.getElementById('profileEmailVisible').checked = p.email_visible === true;

    // Interests checkboxes
    var interests = p.interests || [];
    var boxes = document.querySelectorAll('#profileForm .interest-grid input[type="checkbox"]');
    boxes.forEach(function(box){
      box.checked = interests.indexOf(box.value) !== -1;
    });
  }

  /* ── Username Availability Check ── */
  var usernameInput = document.getElementById('profileUsername');
  if(usernameInput){
    usernameInput.addEventListener('input', function(){
      // Sanitize: only letters, numbers, underscores
      this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '').toLowerCase();
      var val = this.value.trim();
      var statusEl = document.getElementById('usernameStatus');

      if(!val || val === originalUsername){
        statusEl.textContent = '';
        statusEl.className = 'username-status';
        usernameAvailable = true;
        return;
      }
      if(val.length < 3){
        statusEl.textContent = 'Too short';
        statusEl.className = 'username-status taken';
        usernameAvailable = false;
        return;
      }

      statusEl.textContent = '...';
      statusEl.className = 'username-status checking';
      usernameAvailable = false;

      clearTimeout(usernameTimer);
      usernameTimer = setTimeout(async function(){
        if(!window.snProfile) return;
        try {
          var available = await snProfile.checkUsernameAvailable(val);
          // Re-check value hasn't changed
          if(usernameInput.value.trim().toLowerCase() !== val) return;
          if(available){
            statusEl.textContent = 'Available';
            statusEl.className = 'username-status available';
            usernameAvailable = true;
          } else {
            statusEl.textContent = 'Taken';
            statusEl.className = 'username-status taken';
            usernameAvailable = false;
          }
        } catch(err){
          statusEl.textContent = '';
          statusEl.className = 'username-status';
        }
      }, 500);
    });
  }

  /* ── Bio Character Count ── */
  var bioField = document.getElementById('profileBio');
  if(bioField){
    bioField.addEventListener('input', updateBioCount);
  }
  function updateBioCount(){
    var el = document.getElementById('bioCharCount');
    var bio = document.getElementById('profileBio');
    if(el && bio) el.textContent = bio.value.length;
  }

  /* ── Avatar Upload with Crop ── */
  var cropState = { imgEl: null, naturalW: 0, naturalH: 0, scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 };

  document.getElementById('avatarFileInput').addEventListener('change', function(e){
    var file = e.target.files && e.target.files[0];
    if(!file) return;
    e.target.value = '';

    if(!file.type.match(/^image\/(jpeg|png|webp)$/)){
      alert('Please select a JPEG, PNG, or WebP image.');
      return;
    }

    var reader = new FileReader();
    reader.onload = function(ev){ openCropModal(ev.target.result); };
    reader.readAsDataURL(file);
  });

  function openCropModal(dataUrl){
    var modal = document.getElementById('avatarCropModal');
    var cropImg = document.getElementById('cropImg');
    var zoomSlider = document.getElementById('cropZoom');

    cropImg.onload = function(){
      cropState.naturalW = cropImg.naturalWidth;
      cropState.naturalH = cropImg.naturalHeight;
      cropState.scale = 1;
      cropState.x = 0;
      cropState.y = 0;
      zoomSlider.value = 100;
      fitImageToCrop();
    };
    cropImg.src = dataUrl;
    modal.style.display = 'flex';
  }

  function fitImageToCrop(){
    var img = document.getElementById('cropImg');
    var areaSize = 240;
    // Scale so shorter side fills the circle
    var baseScale = Math.max(areaSize / cropState.naturalW, areaSize / cropState.naturalH);
    var zoom = parseInt(document.getElementById('cropZoom').value) / 100;
    var finalScale = baseScale * zoom;
    var w = cropState.naturalW * finalScale;
    var h = cropState.naturalH * finalScale;
    // Clamp position so image covers the circle
    var maxX = 0, minX = areaSize - w;
    var maxY = 0, minY = areaSize - h;
    cropState.x = Math.max(minX, Math.min(maxX, cropState.x));
    cropState.y = Math.max(minY, Math.min(maxY, cropState.y));
    img.style.width = w + 'px';
    img.style.height = h + 'px';
    img.style.left = cropState.x + 'px';
    img.style.top = cropState.y + 'px';
    cropState.scale = finalScale;
  }

  document.getElementById('cropZoom').addEventListener('input', function(){
    fitImageToCrop();
  });

  // Drag to reposition
  var cropArea = document.getElementById('cropArea');
  cropArea.addEventListener('pointerdown', function(e){
    cropState.dragging = true;
    cropState.startX = e.clientX - cropState.x;
    cropState.startY = e.clientY - cropState.y;
    cropArea.style.cursor = 'grabbing';
    cropArea.setPointerCapture(e.pointerId);
  });
  cropArea.addEventListener('pointermove', function(e){
    if(!cropState.dragging) return;
    cropState.x = e.clientX - cropState.startX;
    cropState.y = e.clientY - cropState.startY;
    fitImageToCrop();
  });
  cropArea.addEventListener('pointerup', function(){
    cropState.dragging = false;
    cropArea.style.cursor = 'grab';
  });

  window.cancelCrop = function(){
    document.getElementById('avatarCropModal').style.display = 'none';
  };

  window.confirmCrop = function(){
    var cropImg = document.getElementById('cropImg');
    var areaSize = 240;
    var outputSize = 400;
    var canvas = document.createElement('canvas');
    canvas.width = outputSize;
    canvas.height = outputSize;
    var ctx = canvas.getContext('2d');
    // Calculate source rect from crop position
    var ratio = outputSize / areaSize;
    var sx = -cropState.x / cropState.scale;
    var sy = -cropState.y / cropState.scale;
    var sw = areaSize / cropState.scale;
    var sh = areaSize / cropState.scale;
    ctx.drawImage(cropImg, sx, sy, sw, sh, 0, 0, outputSize, outputSize);
    var dataUrl = canvas.toDataURL('image/jpeg', 0.85);
    var base64 = dataUrl.split(',')[1];
    document.getElementById('avatarCropModal').style.display = 'none';
    doAvatarUpload(base64);
  };

  async function doAvatarUpload(base64){
    var overlay = document.querySelector('.profile-avatar-overlay');
    overlay.textContent = '...';
    overlay.style.opacity = '1';
    try {
      var token = await snAuth.getAccessToken();
      if(!token) throw new Error('Not authenticated');
      var result = await snProfile.uploadAvatar(base64, 'image/jpeg', token);
      currentProfile = result.profile;
      renderProfile();
      // Update navbar avatar
      var navImg = document.getElementById('authAvatarImg');
      var navInitials = document.getElementById('authAvatarInitials');
      if(navImg && result.url){
        navImg.src = result.url;
        navImg.style.display = 'block';
        if(navInitials) navInitials.style.display = 'none';
      }
      overlay.textContent = 'Edit';
      overlay.style.opacity = '';
    } catch(err){
      console.warn('Avatar upload error:', err);
      alert('Failed to upload avatar: ' + (err.message || 'Please try again.'));
      overlay.textContent = 'Edit';
      overlay.style.opacity = '';
    }
  }

  /* ── Save Profile ── */
  window.saveProfile = async function(e){
    e.preventDefault();
    var statusEl = document.getElementById('profileStatus');
    var saveBtn = document.getElementById('profileSaveBtn');

    // Validate username
    var newUsername = document.getElementById('profileUsername').value.trim().toLowerCase();
    if(newUsername && newUsername !== originalUsername && !usernameAvailable){
      statusEl.textContent = 'Username is not available. Please choose another.';
      statusEl.className = 'profile-status error';
      return;
    }
    if(newUsername && newUsername.length < 3){
      statusEl.textContent = 'Username must be at least 3 characters.';
      statusEl.className = 'profile-status error';
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    statusEl.className = 'profile-status';
    statusEl.style.display = 'none';

    // Gather form data
    var interestBoxes = document.querySelectorAll('#profileForm .interest-grid input[type="checkbox"]:checked');
    var interests = [];
    interestBoxes.forEach(function(box){ interests.push(box.value); });

    var updates = {
      display_name: document.getElementById('profileName').value.trim(),
      username: newUsername || originalUsername,
      whatnot_username: document.getElementById('profileWhatnot').value.trim(),
      bio: document.getElementById('profileBio').value.trim(),
      interests: interests,
      profile_public: document.getElementById('profilePublic').checked,
      email_visible: document.getElementById('profileEmailVisible').checked
    };

    try {
      var token = await snAuth.getAccessToken();
      if(!token) throw new Error('Not authenticated');
      currentProfile = await snProfile.updateProfile(updates, token);
      renderProfile();
      statusEl.textContent = 'Profile saved successfully!';
      statusEl.className = 'profile-status success';
      statusEl.style.display = '';
    } catch(err){
      console.warn('Save error:', err);
      statusEl.textContent = 'Error saving profile: ' + (err.message || 'Please try again.');
      statusEl.className = 'profile-status error';
    }

    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Changes';
  };

  /* ── Clear success message when user edits any field ── */
  function clearSaveStatus(){
    var statusEl = document.getElementById('profileStatus');
    if(statusEl && statusEl.classList.contains('success')){
      statusEl.textContent = '';
      statusEl.className = 'profile-status';
      statusEl.style.display = 'none';
    }
  }
  var formEl = document.getElementById('profileForm');
  if(formEl){
    formEl.addEventListener('input', clearSaveStatus);
    formEl.addEventListener('change', clearSaveStatus);
  }

  /* ── Collection Preview ── */
  var COLL_CAT_LABELS = { coins: 'Coins & Bullion', pokemon: 'Pokemon', sports_cards: 'Sports Cards', shoes: 'Shoes' };

  async function loadCollectionPreview(){
    try {
      var token = await snAuth.getAccessToken();
      if(!token || !window.snProfile) return;
      var items = await snProfile.getCollection(token);
      renderCollectionPreview(items.slice(0, 3));
    } catch(err){
      console.warn('Collection preview error:', err);
    }
  }

  function renderCollectionPreview(items){
    var grid = document.getElementById('collectionPreviewGrid');
    if(!grid) return;

    if(!items || items.length === 0){
      grid.innerHTML = '<div class="collection-preview-empty">No items yet. <a href="/collection.html">Start Your Collection</a></div>';
      return;
    }

    var html = '<div class="collection-preview-grid">';
    for(var i = 0; i < items.length; i++){
      var item = items[i];
      var photos = item.photo_urls || [];
      var cat = item.category || 'other';
      var desc = item.description || '';
      if(desc.length > 60) desc = desc.slice(0, 57) + '...';

      html += '<div class="collection-preview-card">';
      if(photos.length > 0){
        html += '<img class="collection-preview-thumb" src="' + escP(photos[0]) + '" alt="' + escP(COLL_CAT_LABELS[cat] || cat) + '" loading="lazy"/>';
      } else {
        html += '<div class="collection-preview-thumb-empty">&#128247;</div>';
      }
      html += '<div class="collection-preview-info">';
      html += '<div class="collection-preview-cat">' + escP(COLL_CAT_LABELS[cat] || cat) + '</div>';
      if(desc) html += '<div class="collection-preview-desc">' + escP(desc) + '</div>';
      html += '</div></div>';
    }
    html += '</div>';
    grid.innerHTML = html;
  }

  function escP(str){
    return snSanitize.html(str);
  }

  /* ── Listen for auth ready event ── */
  window.addEventListener('snauth:ready', function(e){
    if(e.detail && e.detail.profile){
      currentProfile = e.detail.profile;
      renderProfile();
      showSection('profileContent');
      loadCollectionPreview();
    }
  });

  // Boot
  initProfilePage();
})();
</script>
</body>
</html>
